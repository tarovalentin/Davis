(* ::Package:: *)

Quit[];


(********************************************************************************
 *                                                                            *
 *    Two-Loop Amplitudes in Planar, N=4 SYM                                  *
 *                                                                            *
 *    J. Bourjaily and J. Trnka, April 2015                                   *
 *                                                                            *
 *                                                                            *
 ******************************************************************************)
Print[Panel[Column[List[Panel[Graphics[List[List[AbsoluteThickness[3],Line[List[List[Plus[1,Times[Rational[3,2],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],0],List[6.545456337609623`,0.8364132579485728`]]],Line[List[List[Plus[1,Times[Rational[3,2],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],0],List[6.545456337609623`,-0.8364132579485728`]]],List[GrayLevel[0],Disk[List[6.61652530576288`,0.`],0.075`],Disk[List[6.550105732260081`,0.35836794954530027`],0.075`],Disk[List[6.550105732260081`,-0.35836794954530027`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],List[3.34474874504071`,3.568982805178093`]]],Line[List[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],List[4.935701303616009`,3.0520509831248424`]]],List[GrayLevel[0],Disk[List[4.1621865432604075`,3.378107499419996`],0.075`],Disk[List[3.8008335926425167`,3.425680517879416`],0.075`],Disk[List[4.482489939935298`,3.2041969445818133`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[-3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],List[4.935701303616009`,-3.0520509831248424`]]],Line[List[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[-3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],List[3.34474874504071`,-3.568982805178093`]]],List[GrayLevel[0],Disk[List[4.1621865432604075`,-3.378107499419996`],0.075`],Disk[List[4.482489939935298`,-3.2041969445818133`],0.075`],Disk[List[3.8008335926425167`,-3.425680517879416`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[Plus[1,Times[Rational[3,8],Plus[-1,Times[-1,Power[5,Rational[1,2]]]],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Rational[3,2]],List[0.2652684346344085`,2.511271242968684`]]],Line[List[List[Plus[1,Times[Rational[3,8],Plus[-1,Times[-1,Power[5,Rational[1,2]]]],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Rational[3,2]],List[1.3862712429686843`,2.688820645368942`]]],List[GrayLevel[0],Disk[List[0.6909830056250525`,2.4510565162951536`],0.075`],Disk[List[1.`,2.5`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[Plus[1,Times[Rational[3,8],Plus[-1,Times[-1,Power[5,Rational[1,2]]]],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Rational[-3,2]],List[0.2652684346344085`,-2.511271242968684`]]],Line[List[List[Plus[1,Times[Rational[3,8],Plus[-1,Times[-1,Power[5,Rational[1,2]]]],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Rational[-3,2]],List[1.3862712429686843`,-2.688820645368942`]]],List[GrayLevel[0],Disk[List[0.6909830056250525`,-2.4510565162951536`],0.075`],Disk[List[1.`,-2.5`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[-2,1.5`],List[-2.`,2.75`]]],Line[List[List[-2,1.5`],List[-3.25`,1.5`]]],List[GrayLevel[0],Disk[List[-2.7071067811865475`,2.2071067811865475`],0.075`],Disk[List[-2.923879532511287`,1.8826834323650898`],0.075`],Disk[List[-2.3826834323650896`,2.423879532511287`],0.075`]]],List[AbsoluteThickness[3],Line[List[List[-2,-1.5`],List[-2.`,-2.75`]]],Line[List[List[-2,-1.5`],List[-3.25`,-1.5`]]],List[GrayLevel[0],Disk[List[-2.7071067811865475`,-2.2071067811865475`],0.075`],Disk[List[-2.923879532511287`,-1.8826834323650898`],0.075`],Disk[List[-2.3826834323650896`,-2.423879532511287`],0.075`]]],List[Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[0,0]],0],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[1.5`,1.5`]],Times[Rational[-1,2],Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[3,0]],Times[-1,Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[1.5`,-1.5`]],Times[Rational[-3,2],Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[Plus[3,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]],Plus[1,Times[Rational[1,4],Plus[1,Times[-1,Power[5,Rational[1,2]]]]]]]],Times[Rational[-3,8],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]],Plus[1,Power[5,Rational[1,2]]]]]],Times[Rational[2,5],Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[Plus[3,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]],Plus[1,Times[Rational[1,4],Plus[1,Power[5,Rational[1,2]]]]]]],Times[Rational[-3,8],Plus[1,Power[5,Rational[1,2]]]]]],Times[Rational[4,5],Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[Plus[3,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]],Plus[1,Times[Rational[1,4],Plus[1,Power[5,Rational[1,2]]]]]]],Times[Rational[3,8],Plus[1,Power[5,Rational[1,2]]]]]],Times[Rational[6,5],Pi]],Rotate[Translate[List[CapForm["Round"],AbsoluteThickness[3],GrayLevel[0],Line[List[List[-2,-1.5`],List[-2,1.5`]]],List[AbsoluteThickness[12],RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-1,3],Pi],Times[Rational[4,3],Pi]]],0]],Rotate[Circle[List[-2,0],List[0.75`,0.25`],List[Times[Rational[-3,8],Pi],Times[Rational[11,8],Pi]]],0],Arrowheads[0.064`],List[AbsoluteThickness[0],Rotate[Arrow[List[List[Rational[-11,5],0.22`],List[-2,0.25`]],List[-0.25`]],0]]],List[Plus[3,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]],Plus[1,Times[Rational[1,4],Plus[1,Times[-1,Power[5,Rational[1,2]]]]]]]],Times[Rational[3,8],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]],Plus[1,Power[5,Rational[1,2]]]]]],Times[Rational[8,5],Pi]]],List[EdgeForm[List[AbsoluteThickness[3],GrayLevel[0]]],FaceForm[RGBColor[Rational[46,51],Rational[46,51],Rational[46,51]]],Disk[List[-2,1.5`],0.65`],Disk[List[1,1.5`],0.65`],Disk[List[-2,-1.5`],0.65`],Disk[List[1,-1.5`],0.65`],Disk[List[Plus[1,Times[Rational[3,2],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],0],0.65`],Disk[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],0.65`],Disk[List[Plus[1,Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[-1,Power[5,Rational[1,2]]]],Times[Rational[3,8],Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],Rational[-1,2]],Plus[1,Power[5,Rational[1,2]]]]],Times[Rational[-3,2],Power[Times[Power[Plus[Rational[5,8],Times[Rational[-1,8],Power[5,Rational[1,2]]]],-1],Plus[Rational[5,8],Times[Rational[1,8],Power[5,Rational[1,2]]]]],Rational[1,2]]]],0.65`]]],Rule[AspectRatio,Automatic],Rule[PlotRange,List[List[-3.5`,7],List[-4,4]]],Rule[ImageSize,250],Rule[Background,RGBColor[Rational[235,243],Rational[235,243],Rational[1199,1215]]]],Rule[Background,\!\(\*
TagBox[
StyleBox["White",
ShowSpecialCharacters->False,
ShowStringCharacters->True,
NumberMarks->True],
FullForm]\)],Rule[FrameMargins,8]],Row[List[Style["Local Two-Loop Amplitude",Rule[FontFamily,"Times"],Rule[FontSize,18]]]],Row[List[Style["Integrands in Planar SYM",Rule[FontFamily,"Times"],Rule[FontSize,18]]]],Row[List[Style["J. Bourjaily and J. Trnka, 2015",Rule[FontFamily,"Times"],Rule[FontSize,16]]]]],Rule[Alignment,Center]],Rule[Background,RGBColor[Rational[3,4],Rational[3,4],Rational[9,10]]],Rule[FrameMargins,List[List[15,15],List[0,Rational[25,2]]]]]];
BeginPackage["TwoLoop`"]
Begin["Global`"]


(*   General Utilities               *)
memory:=Row[Style[#,FontFamily->"Times",FontSize->18]&/@(Select[Transpose[{(Round[#*1000]/1000.&/@(N@MemoryInUse[]/(Power[2,10#]&/@Range[0,4]))),{"bytes","kB","MB","GB","TB"}}],Mod[#[[1]],1000,1]==#[[1]]&][[1]]),Spacer[1]];
nice[exprn_]:=Block[{graphicsProtect=(Thread[Rule[#,Symbol["gr"<>ToString[#]]&/@Range[Length[#]]]]&@DeleteDuplicates[Cases[exprn,_Graphics,{0,\[Infinity]}]]),diLogRule={Li[x_]:>Subscript[Style["Li",FontFamily->"Times"],2][x],log[x_]:>Style["log",FontFamily->"Times"][x]},integerPaddingRule={(integerSequence:_Integer..)/;(Length[{integerSequence}]>1):>(integerSequence/.{q_Integer:>If[q>9,Row[List[Spacer[2],ToString[q],Spacer[2]]],ToString[q]]})},ampRule={treeAmp[n_,k_]:>Subsuperscript[Style["A",FontFamily->"Times",FontSize->36,Italic],Style[n,FontFamily->"Times",FontSize->26],Row[Style[#,FontFamily->"Times",FontSize->24]&/@{"(",k,")"}]]},kermitRule={kermit[a_,b___][x_,y_]:>Row[Flatten[{Subsuperscript["K",If[NumberQ[a],2,1],If[NumberQ[a],"",If[a===A,Subscript["\[ScriptL]",1],If[NumberQ[a],"2",Subscript["\[ScriptL]",2]]]]],"[(",x,");(",y,")]"}]]},loopLineRule=(RuleDelayed[h_[x___,#1,#2,y___],h[x,Row[{"(",#3,")"}],y]]&@@@(Join@@@Transpose[{({{Symbol["A"],Symbol["B"]},{Symbol["C"],Symbol["D"]},{Symbol["X1"],Symbol["X2"]}}),{{Subscript["\[ScriptL]",1],""},{Subscript["\[ScriptL]",2],""},{"X",""}}}])),loopVariableNameRule=(Rule@@@Transpose[Join@@@{({Symbol["A"<>ToString[#]],Symbol["B"<>ToString[#]]}&/@Range[1]),{{"A","B"}}}]),shiftRule={shift[x_,y_]:>Row[Flatten@{"Q[",Riffle[x,","],"]"}]},capRule={cap[x_,y_,z___]:>Row[Flatten[List[If[Length[x]>1,{"(",x,")"},x],"\[Intersection]",If[Length[y]>1,{"(",y,")"},y]]]]},bracketRule={ab[x__]:>Row[{"\[LeftAngleBracket]",x,"\[RightAngleBracket]"}],sb[x__]:>Row[{"[",x,"]"}],asb[x_,y_,z_]:>Row[Flatten[{"\[LeftAngleBracket]",x,"|(",Riffle[y,"+"],")|",z,"]"}]],m[x__]:>Row[{"(",x,")"}]},subscriptRule={head_[q_Integer]:>If[Length[Variables[head[q]]]>0&&(Head[head]===Symbol),Subscript[head,q],head[q]]},ruleRule=({ruleList:{_Rule..}:>Block[{ruleRows=({ruleList/. {(q_->r_):>Row[{q,"\[Rule]",r},Alignment->Center]}})},(Grid[((#)/.({}->"")),ItemStyle->{FontSize->1.4($DefaultFont)[[2]]},ItemSize->Full,Alignment->Left])&@Transpose@Partition[Flatten[ruleRows,1],Ceiling[Length[Flatten[ruleRows,1]]/Which[Length[Flatten[ruleRows,1]]<10,1,Length[Flatten[ruleRows,1]]<20,2,True,3]],Ceiling[Length[Flatten[ruleRows,1]]/Which[Length[Flatten[ruleRows,1]]<10,1,Length[Flatten[ruleRows,1]]<20,2,True,3]],1,{{}}]]}),matrixRule={Grid[q_?MatrixQ,y___]:>Grid[q,y],q_?MatrixQ:>MatrixForm[q]}},Replace[Fold[Replace[#1,#2,{0,\[Infinity]}]&,(exprn),{graphicsProtect,integerPaddingRule,loopLineRule,loopLineRule,diLogRule,shiftRule,loopVariableNameRule,capRule,subscriptRule,bracketRule,ampRule,kermitRule,ruleRule,Reverse/@graphicsProtect}],matrixRule,{0,1}]];
niceTime[timeInSec_]:=If[timeInSec<($TimeUnit/100)||Not[NumericQ[timeInSec]]||Precision[timeInSec]==0,"",Block[{measure=Select[Transpose[{(Quotient[Mod[timeInSec,#1],#2]&@@@Partition[{timeInSec 10,3.15569277216`*^7,3600*24.,3600.,60.,1.,10^-3,10.^-6,10.^-9},2,1]),{" years"," days"," hours"," minutes"," seconds"," ms"," \[Mu]s"," ns"}}],#[[1]]>0&]},If[Length[measure]>0,Row[Row[#,""]&/@measure[[1;;Min[2,Length[measure]]]],", "],""]]];
timed[exprn_]:=Block[{t0=AbsoluteTime[],exprnHead=Unevaluated[exprn][[0]],output},If[exprnHead===Map,exprnHead=Unevaluated[exprn][[1,0]];];If[exprnHead===Function,exprnHead="";,exprnHead=Row[{" ",Style[exprnHead,Bold]}];];output=Evaluate[exprn];Print["   Evaluation of the function",exprnHead," required ",niceTime[AbsoluteTime[]-t0]," to complete."];output];SetAttributes[timed,HoldFirst];
random[list_]:=randomSubset[1][list][[1]];randomSubset[length_:5][set_]:=set[[(If[Length[#]<length,#,#[[1;;length]]]&@DeleteDuplicates[RandomInteger[{1,Length[set]},{2 length}]])]];
complement[lista_,listbs__]:=Block[{dual=Join@@{listbs}},Select[lista,Not[MemberQ[dual,#]]&]];


(*   Numerical-Operations            *)
(*   ---   Kinematics Specification  *)
referenceKinematics[n_Integer]:=(Zs=Array[Binomial[#1+#2-2,#1-1]&,{n+6,4}];Ls=Zs[[1;;n,1;;2]];ab[x__]:=ab[x]=Det[Ls[[{x}]]];Lbs=((Normal[SparseArray[Thread[Rule[#,(ab@@@Partition[RotateLeft[#],2,1,1])/(ab@@#[[1;;2]]*ab@@#[[2;;3]])]],n]]&/@(RotateRight@Partition[Range[n],3,1,1])) . Zs[[1;;n,3;;4]]);ClearAll[ab];Zs=ReplacePart[Zs,{-6->Zs[[-6]]+Zs[[-7]]-0Zs[[-5]],-4->Zs[[-4]]+Zs[[-5]]-0Zs[[-3]],-2->Zs[[-2]]+Zs[[-3]]-0Zs[[-1]]}];)
randomPositiveKinematics[n_]:=(Zs=Nest[Function[{mat},Block[{hatted=Append[Append[Total[mat[[#;;-1]]],1]&/@Range[2,Length[mat]],Append[PadRight[{},Length[mat[[1]]]],1]],newRow=RandomInteger[{1,10},{Length[mat]}]},newRow*hatted]],RandomInteger[{1,10},{n+10,1}],3];Zs=Transpose[Inverse[Transpose@Zs[[{1,2,3,4}]]] . Transpose[Zs]][[5;;-1]];);
showTwistors:=(Row[{Grid[Prepend[Transpose[Zs[[1;;-7]]],nice[Zs[[#]]]&/@Range[Length[Zs]-6]],Dividers->{{1->True,-1->True},{1->True,-1->True,2->{Thick,Darker[Blue]}}}],Grid[Prepend[Transpose[Zs[[-6;;-5]]],{"A","B"}],Dividers->{{1->True,-1->True},{1->True,-1->True,2->{Thick,Darker[Blue]}}}],Grid[Prepend[Transpose[Zs[[-4;;-3]]],{"C","D"}],Dividers->{{1->True,-1->True},{1->True,-1->True,2->{Thick,Darker[Blue]}}}],Grid[Prepend[Transpose[Zs[[-2;;-1]]],{"F","G"}],Dividers->{{1->True,-1->True},{1->True,-1->True,2->{Thick,Darker[Blue]}}}]},Spacer[10]]);;
localPoles[n_,ell_:2]:=((Times@@(ab@@@Select[Flatten/@Subsets[Partition[Range[n],2,1,1],{2}],Length[DeleteDuplicates[#]]==4&])))(Times@@Flatten[Table[(ab[j[[1]],j[[2]],##]&@@@Partition[Range[n],2,1,1]),{j,{{A,B},{C,D},{E,F}}[[1;;ell]]}]])(Times@@(ab@@@(Flatten/@Subsets[{{A,B},{C,D},{E,F}}[[1;;ell]],{2}])));


(*   Numerical-Operations            *)
(*   ---   Evaluation                *)
evaluate[exprn_]:=Block[{wExprn},ClearAll[ab,cap,power,kermit,Li,log];wExprn=ReleaseHold[exprn];If[Count[exprn,kermit[2][__],{0,\[Infinity]}]>0,symEvaluate[exprn],(If[Count[exprn,R[___],{0,\[Infinity]}]>0,wExprn=fromRform[][wExprn];];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y) . ((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{},-Times[Power[Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]})),-1],Power[ab[A,B,cap[x,y]],2]]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];Times[Power[(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]}))),-1],Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2]]];wExprn=wExprn;ab[x__]:=ab[x]=Det[Zs[[{x}/.{F->-2,G->-1,A->-6,B->-5,C->-4,D->-3}]]];Li[x_]:=Li[x]=PolyLog[2,x];log[x_]:=log[x]=Log[x];wExprn=wExprn;wExprn=((wExprn/.power[x_,1/2]:>power[Simplify[x],1/2])//.{power[power[x_,2],1/2]:>x}//.{power[power[x_,2]/power[y_,2],1/2]:>x/y});power[x_,y_]:=Power[x,y];wExprn=wExprn;ClearAll[ab,cap,kermit,Li,power,log];wExprn)]];SetAttributes[evaluate,HoldFirst];
symEvaluate[exprn_]:=Block[{wExprn,dynamicN=0,rParts,res1,res2,mats1,mats2,resList,sym1,sym2,output},ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];wExprn=ReleaseHold[exprn];wExprn=If[Head[wExprn]===List,wExprn,{wExprn}];mats1=mats2=Cases[#,R[__]]&/@wExprn;ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y) . ((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x__]:=ab[x]=(dynamicN=Max[{dynamicN,Max[Cases[{x},_Integer]]}];Det[Zs[[{x}/.{X1->-6,X2->-5,A->-4,B->-3,C->-2,D->-1}]]]);kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{denom,num},denom=Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]}));num=-Power[ab[A,B,cap[x,y]],2];If[num===0||denom===0,0,num/denom]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{denom,num,aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];denom=(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]})));num=Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2];If[num===0||denom===0,0,num/denom]];R[x__]:=R[x]=Block[{ans=Times@@(ab@@@Partition[{x},4,1,1])},If[ans===0,0,1/ans]];res1=Quiet[wExprn];ClearAll[R];R[t__]:=R[t]=(((r[t]+rE[])//.{r[x___,y_,z___,y_,w___]->rE[],r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],dynamicN]],rE[]:>Normal[SparseArray[{},dynamicN]]});mats1=mats1;ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];sym1=Transpose[{res1,mats1}];ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y) . ((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x__]:=ab[x]=(Det[Zs[[{x}/.{X1->-6,X2->-5,A->-2,B->-1,C->-4,D->-3}]]]);kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{denom,num},denom=Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]}));num=-Power[ab[A,B,cap[x,y]],2];If[num===0||denom===0,0,num/denom]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{denom,num,aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];denom=(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]})));num=Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2];If[num===0||denom===0,0,num/denom]];R[x__]:=R[x]=Block[{ans=Times@@(ab@@@Partition[{x},4,1,1])},If[ans===0,0,1/ans]];res2=Quiet[wExprn];ClearAll[R];R[t__]:=R[t]=(((r[t]+rE[])//.{r[x___,y_,z___,y_,w___]->rE[],r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],dynamicN]],rE[]:>Normal[SparseArray[{},dynamicN]]});mats2=mats2;ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];sym2=Transpose[{res2,mats2}];output=DeleteDuplicates[Select[Join@@Transpose[{sym1,sym2}],Count[#,Indeterminate|ComplexInfinity,{0,\[Infinity]}]==0&]];If[Length[output]>=1,If[Length[output[[1,2]]]==0,output[[All,1]],output],output]];SetAttributes[symEvaluate,HoldFirst];
(*evaluate[exprn_]:=Block[{wExprn},ClearAll[ab,cap,power,kermit,Li,log];wExprn=ReleaseHold[exprn];If[Count[exprn,kermit[2][__],{0,\[Infinity]}]>0,symEvaluate[exprn],(If[Count[exprn,R[___],{0,\[Infinity]}]>0,fullEvaluate[exprn],(ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y).((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{},-Times[Power[Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]})),-1],Power[ab[A,B,cap[x,y]],2]]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];Times[Power[(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]}))),-1],Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2]]];wExprn=wExprn;ab[x__]:=ab[x]=Det[Zs[[{x}/.{X1->-2,X2->-1,A->-4,B->-3,C->-2,D->-1}]]];Li[x_]:=Li[x]=PolyLog[2,x];log[x_]:=log[x]=Log[x];wExprn=wExprn;wExprn=((wExprn/.power[x_,1/2]:>power[Simplify[x],1/2])//.{power[power[x_,2],1/2]:>x}//.{power[power[x_,2]/power[y_,2],1/2]:>x/y});power[x_,y_]:=Power[x,y];wExprn=wExprn;ClearAll[ab,cap,kermit,Li,power,log];wExprn)])]];SetAttributes[evaluate,HoldFirst];
fullEvaluate[exprn_]:=Block[{wExprn,dynamicN=0,rParts,res1,res2,mats1,mats2,resList,sym1,sym2,output},ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];wExprn=ReleaseHold[exprn];wExprn=If[Head[wExprn]===List,wExprn,{wExprn}];mats1=mats2=Cases[#,R[__]]&/@wExprn;ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y).((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x__]:=ab[x]=(dynamicN=Max[{dynamicN,Max[Cases[{x},_Integer]]}];Det[Zs[[{x}/.{X1->-6,X2->-5,A->-4,B->-3,C->-2,D->-1}]]]);kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{denom,num},denom=Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]}));num=-Power[ab[A,B,cap[x,y]],2];If[num===0||denom===0,0,num/denom]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{denom,num,aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];denom=(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]})));num=Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2];If[num===0||denom===0,0,num/denom]];R[x__]:=R[x]=Block[{ans=Times@@(ab@@@Partition[{x},4,1,1])},If[ans===0,0,1/ans]];res1=Quiet[wExprn];ClearAll[R];R[t__]:=R[t]=(((r[t]+rE[])//.{r[x___,y_,z___,y_,w___]->rE[],r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],dynamicN]],rE[]:>Normal[SparseArray[{},dynamicN]]});mats1=mats1;ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];sym1=Transpose[{res1,mats1}];output=DeleteDuplicates[Select[sym1,Count[#,Indeterminate|ComplexInfinity,{0,\[Infinity]}]==0&]];If[Length[output]>=1,If[Length[output[[1,2]]]==0,output[[All,1]],output],output]];SetAttributes[fullEvaluate,HoldFirst];
symEvaluate[exprn_]:=Block[{wExprn,dynamicN=0,rParts,res1,res2,mats1,mats2,resList,sym1,sym2,output},ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];wExprn=ReleaseHold[exprn];wExprn=If[Head[wExprn]===List,wExprn,{wExprn}];mats1=mats2=Cases[#,R[__]]&/@wExprn;ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y).((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x__]:=ab[x]=(dynamicN=Max[{dynamicN,Max[Cases[{x},_Integer]]}];Det[Zs[[{x}/.{X1->-6,X2->-5,A->-4,B->-3,C->-2,D->-1}]]]);kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{denom,num},denom=Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]}));num=-Power[ab[A,B,cap[x,y]],2];If[num===0||denom===0,0,num/denom]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{denom,num,aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];denom=(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]})));num=Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2];If[num===0||denom===0,0,num/denom]];R[x__]:=R[x]=Block[{ans=Times@@(ab@@@Partition[{x},4,1,1])},If[ans===0,0,1/ans]];res1=Quiet[wExprn];ClearAll[R];R[t__]:=R[t]=(((r[t]+rE[])//.{r[x___,y_,z___,y_,w___]->rE[],r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],dynamicN]],rE[]:>Normal[SparseArray[{},dynamicN]]});mats1=mats1;ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];sym1=Transpose[{res1,mats1}];ab[x___,cap[y_,z_,q___],w___]:=ab[x,cap[y,z,q],w]=If[Length[Join[y,z]]==5,(ab[x,#,w]&/@y).((ab@@@RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]])),Total[(((ab[x,#1,#2,w]ab@@Prepend[z,#3]))&@@@Partition[y,3,1,1])]];ab[x___,shift[y_,z_],w___]:=ab[x,shift[y,z],w]=ab[x,y[[1]],w]+z ab[x,y[[2]],w];ab[x___,dif[q_,r_],y___]:=ab[x,dif[q,r],y]=ab[x,Sequence@@q,y]-ab[x,Sequence@@r,y];ab[x__]:=ab[x]=(Det[Zs[[{x}/.{X1->-6,X2->-5,A->-2,B->-1,C->-4,D->-3}]]]);kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{denom,num},denom=Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]}));num=-Power[ab[A,B,cap[x,y]],2];If[num===0||denom===0,0,num/denom]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{denom,num,aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];denom=(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]})));num=Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2];If[num===0||denom===0,0,num/denom]];R[x__]:=R[x]=Block[{ans=Times@@(ab@@@Partition[{x},4,1,1])},If[ans===0,0,1/ans]];res2=Quiet[wExprn];ClearAll[R];R[t__]:=R[t]=(((r[t]+rE[])//.{r[x___,y_,z___,y_,w___]->rE[],r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],dynamicN]],rE[]:>Normal[SparseArray[{},dynamicN]]});mats2=mats2;ClearAll[ab,cap,shift,kermit,Li,log,onShellGraph,scalarBox,pBox,pBoxes,kBox,kBoxes,amp,R];sym2=Transpose[{res2,mats2}];output=DeleteDuplicates[Select[Join@@Transpose[{sym1,sym2}],Count[#,Indeterminate|ComplexInfinity,{0,\[Infinity]}]==0&]];If[Length[output]>=1,If[Length[output[[1,2]]]==0,output[[All,1]],output],output]];SetAttributes[symEvaluate,HoldFirst];*)


(*   BCFW 0-2-Loop Recursions        *)
(*                                   *)
bcfwPartitions[n_,k_,ell_:0]:=Select[Flatten[Table[{{n-nR+2,k-kR-1,ell-ellR},{nR,kR,ellR}},{nR,4,n-1},{kR,0,nR-4},{ellR,0,ell}],2],Function[{nL,kL,ellL},(0<=kL<=nL-4)||(nL==3&&kL==0&&ellL==0)]@@#[[1]]&];
bcfwBridge[0][{nL_,kL_,ellL_},{nR_,kR_,ellR_}][twistorLabels_]:=Block[{jHat,nHat,rightLabelRules,leftAmp,rightAmp},jHat=cap[twistorLabels[[{nL-1,nL}]],twistorLabels[[{-1,-2,1}]]];nHat=cap[twistorLabels[[{-1,-2}]],twistorLabels[[{nL,nL-1,1}]]];rightLabelRules=Join[Thread[Rule[Range[nR],ReplacePart[twistorLabels[[nL-1;;-1]],{1->jHat,-1->nHat}]]],If[ellL==1,{A->C,B->D},{}]];leftAmp=(rAmp[nL,kL,ellL]/.{R[x__]:>R@@({x}/.{nL->jHat}),kermit[y__][x__]:>kermit[y]@@({x}/.{nL->jHat}),ab[x__]:>ab@@({x}/.{nL->jHat})});rightAmp=(rAmp[nR,kR,ellR]/.{R[x__]:>R@@({x}/.rightLabelRules),kermit[y__][x__]:>kermit[Sequence@@({y}/.If[ellL==1,{A->C,B->D},{}])]@@({x}/.rightLabelRules),ab[x__]:>ab@@({x}/.rightLabelRules)});Times@@@Tuples[{leftAmp,{(R@@twistorLabels[[{1,nL-1,nL,-2,-1}]])},rightAmp}]];bcfwBridge[1][{nL_,kL_,ellL_},{nR_,kR_,ellR_}][inputLabels_]:=Block[{jHat,nHat,aHat,rightLabelRules,leftLabelRules,leftAmp,rightAmp,twistorLabels=(RotateRight[inputLabels])},jHat=cap[twistorLabels[[{nL-1,nL}]],twistorLabels[[{-1,1,2}]]];aHat=cap[twistorLabels[[{-3,-2,2}]],twistorLabels[[{-1,1}]]];nHat=cap[twistorLabels[[{-2,-3}]],twistorLabels[[{-1,1,2}]]];leftLabelRules=Join[Thread[Rule[Range[nL],ReplacePart[twistorLabels[[1;;nL]],{1->aHat,nL->jHat}]]],If[ellL+ellR==1,{A->C,B->D},{}]];rightLabelRules=Join[Thread[Rule[Range[nR],ReplacePart[twistorLabels[[nL-1;;-1]],{1->jHat,-2->nHat,-1->aHat}]]],If[ellL+ellR==1,{A->C,B->D},{}]];leftAmp=(rAmp[nL,kL,ellL]/.{R[x__]:>R@@(({x}/.leftLabelRules)/.{}),kermit[y__][x__]:>kermit[Sequence@@({y}/.If[ellL+ellR==1,{A->C,B->D},{}])]@@(({x}/.leftLabelRules)/.{})});rightAmp=(rAmp[nR,kR,ellR]/.{R[x__]:>R@@(({x}/.rightLabelRules)/.{}),kermit[y__][x__]:>kermit[Sequence@@({y}/.If[ellL+ellR==1,{A->C,B->D},{}])]@@(({x}/.rightLabelRules)/.{})});Times@@@Tuples[{leftAmp,{(kermit[A,B]@@{twistorLabels[[{2,nL-1,nL}]],twistorLabels[[{2,-3,-2}]]})},rightAmp}]];bcfwBridge[2][{nL_,kL_,ellL_},{nR_,kR_,ellR_}][inputLabels_]:=Block[{jHat,nHat,aHat,cHat,rightLabelRules,leftLabelRules,leftAmp,rightAmp,twistorLabels=RotateRight[inputLabels,2],ephN=inputLabels[[-5]],output},nHat=cap[twistorLabels[[{-3,-4}]],twistorLabels[[{-2,2,3}]]];aHat=cap[twistorLabels[[{-4,-3,3}]],twistorLabels[[{-2,2}]]];cHat=cap[twistorLabels[[{-2,2,3}]],twistorLabels[[{-1,1}]]];jHat=cap[(twistorLabels[[{nL-1,nL}]]/.{}),Append[twistorLabels[[{-1,1}]],aHat]];leftLabelRules=Thread[Rule[RotateRight[Range[nL],1],ReplacePart[RotateLeft[twistorLabels[[1;;nL]],0],{2->aHat,1->cHat,nL->jHat}]]];rightLabelRules=Thread[Rule[Range[nR],ReplacePart[twistorLabels[[nL-1;;-1]],{1->jHat,-3->nHat,-2->aHat,-1->cHat}]]];leftAmp=(rAmp[nL,kL,ellL]/.{R[x__]:>R@@({x}/.leftLabelRules)});rightAmp=(rAmp[nR,kR,ellR]/.{R[x__]:>R@@({x}/.rightLabelRules)});output=(Times@@@Tuples[{leftAmp,{(kermit[2]@@{(twistorLabels[[{3,nL-1,nL}]]/.{twistorLabels[[-3]]->nHat}),twistorLabels[[{3,-4,-3}]]})},rightAmp}]);DeleteCases[(integrateEta/@output),0]];integrateEta[exprn_]:=Block[{rSupport=Cases[exprn,R[x___,cap[{A,B,1},{C,D}],y___]],others,resultFactor},If[Length[rSupport]==0,0,(rSupport=rSupport[[1]];others=(rSupport/.R[x___,cap[{A,B,1},{C,D}],y___]:>{y,x});(resultFactor=Power[Times@@(ab@@@Partition[(List@@rSupport),4,1,1]),-1]Power[ab@@others,4];((exprn/.{rSupport->resultFactor,R[x___]:>R@@({x}/.{cap[{A,B,1},{C,D}]->cap[others,{cap[{A,B,1},{C,D}]}]})})/.{})))]];
rAmp[n_,k_,ell_:0]:=rAmp[n,k,ell]=Which[(k==0||n==3)&&(ell==0),{1},k<0||k>n-4,{},True,Join[rAmp[n-1,k,ell],(Join@@(bcfwBridge[0][##][Range[n]]&@@@bcfwPartitions[n,k,ell])),If[ell==0,{},(Join@@(bcfwBridge[1][##][Join[Range[n],{A,B}]]&@@@bcfwPartitions[n+2,k+1,ell-1][[1;;-2]]))],If[ell<=1,{},(Join@@(bcfwBridge[2][##][Join[Range[n],{A,C,D,B}]]&@@@bcfwPartitions[n+4,k+2,ell-2][[1;;-2]]))]]];


(*   General Utilities               *)
(*   ---   Analytic Explicification  *)
explicitKermits[exprn_]:=Block[{wExprn},ClearAll[ab,cap,kermit,Li,log];wExprn=ReleaseHold[exprn];kermit[A_,B_][x_,y_]:=kermit[A,B][x,y]=Block[{},-Times[Power[Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[x,2,1,1],Partition[y,2,1,1]})),-1],Power[ab[A,B,cap[x,y]],2]]];kermit[2][x_,y_]:=kermit[2][x,y]=Block[{aHat=cap[{A,B},y],X},X=RotateLeft[ReplacePart[x,{1->aHat}]];Times[Power[(Times@@Join@@((ab[A,B,##]&@@@#&/@{Partition[y,2,1,1]})))ab[A,B,C,D](Times@@Join@@((ab[C,D,##]&@@@#&/@{Partition[X,2,1,1]}))),-1],Power[ab[A,B,cap[y,{x[[1]],C,D}]],2]Power[ab[C,D,cap[X,{A,B,x[[1]]}]],2]]];wExprn=wExprn;wExprn=wExprn;ClearAll[ab,cap,kermit,Li,log];wExprn];SetAttributes[explicitKermits,HoldFirst];
symmetrize[exprn_]:=Total[(exprn/.{{},{ab[A,B,C,D]->ab[A,B,C,D],ab[x___]:>ab@@({x}/.Thread[Rule[{A,B,C,D},{C,D,A,B}]])}})];
fromRform[inputN_:0,expandKermitsQ_:False][inputExprn_]:=Module[{n=If[Not[inputN==0],inputN,Max[Cases[Flatten[{((Cases[inputExprn,_R,{0,\[Infinity]}]//.cap[x__]:>List[x]//.shift[x_,y_]:>x)//.R[x__]:>List[x]),((Cases[inputExprn,_kermit,{0,\[Infinity]}]//.cap[x__]:>List[x]//.shift[x_,y_]:>x)//.kermit[q_][x__]:>List[x])}],_Integer]]],exprn=If[Head[inputExprn]===List,inputExprn,{inputExprn}]},Block[{wExprn=(exprn/.Times[z___,x_R,y___R]:>times[z,x,y]),resParts,deltaParts,full},R[x__]:=R[x]=(Power[Times@@(ab@@@Partition[{x},4,1,1]),-1]);times[x__]:=Times[x];resParts=wExprn;ClearAll[R,times];deltaParts=Cases[#,_R,{0,\[Infinity]}]&/@wExprn;R[t__]:=R[t]=((r[t]//.{r[x___,y_,z___,y_,w___]->0,r[x___,cap[y_,z_,q___],w___]:>(Block[{fullRange=Join[y,z]},Total[(r[x,fullRange[[#]],w](ab@@(RotateLeft[Partition[fullRange,4,1,1]][[#]])))&/@Range[Length[y]]]]),r[x___,shift[{y1_,y2_},z_],w___]:>(r[x,y1,w]+z r[x,y2,w])})/.{r[x___]:>Normal[SparseArray[Thread[Rule[{x},ab@@@Partition[RotateLeft[{x}],4,1,1]]],n]]});deltaParts=deltaParts;ClearAll[R,times];If[TrueQ[expandKermitsQ],(resParts=explicitKermits[resParts];)];full=Transpose[{resParts,deltaParts}]]];
toAnalytic[exprn_,symmetrizeIntsQ_:True]:=Block[{wExprn},ClearAll[onShellGraph,scalarBox,chiralBox,treeAmp,R,boxes,scalarTriangle,doubleCompositeBox,doubleCompositeBox,compositeDoubleBoxes,compositePentaBoxes,kBoxes,pBoxes,doubleTriangle];wExprn=ReleaseHold[exprn];If[Not[Head[wExprn]===List],wExprn={wExprn};];kBoxes[num__][legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[num][legs])},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];pBoxes[num__][legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[num][legs])},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];doubleTriangle[legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[0][legs])},Sequence@@((int*onShellFunction[0][legs,#]&/@kLists))];compositePentaBoxes[num_][legs_,triLegs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[chiralBox[num][legs],scalarBox[{{triLegs[[1]]},{triLegs[[2]]},Mod[Range[Max[Flatten[legs]]-2]+triLegs[[2]],Max[Flatten[legs]],1]}]]/.mergerRule)},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];compositeDoubleBoxes[num_][legs_,triLegs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[chiralBox[num][legs],scalarBox[{{triLegs[[1]]},{triLegs[[2]]},Mod[Range[Max[Flatten[legs]]-2]+triLegs[[2]],Max[Flatten[legs]],1]}]]/.mergerRule)},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];treeAmp[n_,k_]:=(rAmp[n,k]);doubleCompositeBox[legs_]:=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[scalarBox[{legs[[1]],legs[[2]],Join@@legs[[3;;-1]]}],scalarBox[{legs[[4]],legs[[5]],Join@@legs[[{6,1,2,3}]]}]]/.mergerRule);boxes[num_][legs_,kLists_]:=Block[{int=-chiralIntegrand[num][legs]},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];wExprn=wExprn;scalarTriangle[legs_]:=-scalarBoxIntegrand[legs];wExprn=Join@@wExprn;ClearAll[onShellGraph,scalarBox,chiralBox,treeAmp,R,boxes,scalarTriangle,doubleCompositeBox,doubleCompositeBox,compositeDoubleBoxes,compositePentaBoxes,kBoxes,pBoxes,doubleTriangle];wExprn];SetAttributes[toAnalytic,HoldFirst];
toFullAnalytic[exprn_,symmetrizeIntsQ_:True]:=Block[{wExprn,workingN=0},ClearAll[onShellGraph,scalarBox,chiralBox,treeAmp,R,boxes,scalarTriangle,doubleCompositeBox,doubleCompositeBox,compositeDoubleBoxes,compositePentaBoxes,kBoxes,pBoxes,doubleTriangle];wExprn=ReleaseHold[exprn];If[Not[Head[wExprn]===List],wExprn={wExprn};];kBoxes[num__][legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[num][legs])},workingN=Max[{workingN,Max[Cases[Flatten[legs],_Integer]],Length[Flatten[legs]]}];Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];pBoxes[num__][legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[num][legs])},workingN=Max[{workingN,Max[Cases[Flatten[legs],_Integer]],Length[Flatten[legs]]}];Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];doubleTriangle[legs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(chiralIntegrand[0][legs])},workingN=Max[{workingN,Max[Cases[Flatten[legs],_Integer]],Length[Flatten[legs]]}];Sequence@@((int*onShellFunction[0][legs,#]&/@kLists))];compositePentaBoxes[num_][legs_,triLegs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[chiralBox[num][legs],scalarBox[{{triLegs[[1]]},{triLegs[[2]]},Mod[Range[Max[Flatten[legs]]-2]+triLegs[[2]],Max[Flatten[legs]],1]}]]/.mergerRule)},workingN=Max[{workingN,Max[Cases[Flatten[legs],_Integer]],Length[Flatten[legs]]}];Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];compositeDoubleBoxes[num_][legs_,triLegs_,kLists_]:=Block[{int=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[chiralBox[num][legs],scalarBox[{{triLegs[[1]]},{triLegs[[2]]},Mod[Range[Max[Flatten[legs]]-2]+triLegs[[2]],Max[Flatten[legs]],1]}]]/.mergerRule)},workingN=Max[{workingN,Max[Cases[Flatten[legs],_Integer]],Length[Flatten[legs]]}];Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];treeAmp[n_,k_]:=(workingN=n;rAmp[n,k]);doubleCompositeBox[legs_]:=If[TrueQ[symmetrizeIntsQ],symmetrize[#],#]&@(merge[scalarBox[{legs[[1]],legs[[2]],Join@@legs[[3;;-1]]}],scalarBox[{legs[[4]],legs[[5]],Join@@legs[[{6,1,2,3}]]}]]/.mergerRule);boxes[num_][legs_,kLists_]:=Block[{int=-chiralIntegrand[num][legs]},Sequence@@((int*onShellFunction[num][legs,#]&/@kLists))];wExprn=wExprn;scalarTriangle[legs_]:=-scalarBoxIntegrand[legs];wExprn=Join@@wExprn;ClearAll[onShellGraph,scalarBox,chiralBox,treeAmp,R,boxes,scalarTriangle,doubleCompositeBox,doubleCompositeBox,compositeDoubleBoxes,compositePentaBoxes,kBoxes,pBoxes,doubleTriangle];If[Count[wExprn,R[___],{0,\[Infinity]}]>0,fromRform[workingN][wExprn],wExprn]];SetAttributes[toFullAnalytic,HoldFirst];


(*   Local Integrand Representations *)
(*   ---   On-Shell Diagram Expansion*)
scalarBoxes[n_,1]:=scalarBoxes[n,1]=Block[{legLists=RotateLeft[#,Ordering[Partition[Length/@#,4,1,1],1][[1]]-1]&/@Flatten[Mod[Table[{Range[l+1,i+n],Range[i+1,j],Range[j+1,k],Range[k+1,l]},{i,1,n-2},{j,i+1,n-1},{k,j+1,n},{l,k+1,n}],n,1],3]},{Cases[legLists,{{m1_},{m2_},{m3_},w___}],Cases[legLists,{{m1_},{y1_,y2__},{m2_},w___}],Cases[legLists,{{m1_},{m2_},{y1_,y2__},w___}],Cases[legLists,{{m1_},{y1_,y2__},{z1_,z2__},w___}],Sort[#,#1[[1]]<#2[[1]]&]&/@Cases[legLists,{{y1_,y2__},w___}]}];scalarBoxes[n_,2]:=scalarBoxes[n,2]=Mod[#,n,1]&/@#&/@(List[((Range[#1,#2-1+If[#2<#1-1,n,0]]&@@@Partition[#,2,1,1])&/@Join[(Insert[Insert[#,#[[3]],{4}],#[[1]],{-1}]&/@Join@@(Partition[#,4,1,1][[1;;2]]&/@Subsets[Range[n],{4}])),(Insert[#,#[[1]],{-1}]&/@Join@@(Partition[#,5,1,1]&/@Subsets[Range[n],{5}])),(Join@@(Partition[#,6,1,1][[1;;3]]&/@Subsets[Range[n],{6}]))]),((Range[#1,#2-1+If[#2<#1-1,n,0]]&@@@Partition[#,2,1,1])&/@Join[(Insert[Insert[#,#[[4]],{4}],#[[1]],{-1}]&/@Join@@(Partition[#,5,1,1]&/@Subsets[Range[n],{5}])),(Insert[#,#[[1]],{-1}]&/@Join@@(Partition[#,6,1,1]&/@Subsets[Range[n],{6}])),(Insert[#,#[[4]],{4}]&/@Join@@(Partition[#,6,1,1]&/@Subsets[Range[n],{6}])),(Join@@(Partition[#,7,1,1]&/@Subsets[Range[n],{7}]))]),((Range[#1,#2-1+If[#2<#1-1,n,0]]&@@@Partition[#,2,1,1])&/@Join[(Insert[Insert[#,#[[4]],{4}],#[[1]],{-1}]&/@Join@@(Partition[#,6,1,1][[1;;3]]&/@Subsets[Range[n],{6}])),(Insert[#,#[[1]],{-1}]&/@Join@@(Partition[#,7,1,1][[1;;-1]]&/@Subsets[Range[n],{7}])),(Join@@(Partition[#,8,1,1][[1;;4]]&/@Subsets[Range[n],{8}]))])]);massiveDoubleTriangles[n_]:=Block[{allBoxes=scalarBoxes[n,2][[1]]},Cases[allBoxes,{{x1_,y1__},{x2_,y2__},{y3___},{x4_,y4__},{x5_,y5__},{y6___}}]];
oneLoopColourings[k_]:=oneLoopColourings[k]=(List[Join[If[k>0,{{0,-1,0,k-1}},{}],{{-1,0,-1,k}}],Join[Table[{-1,j,-1,k-j},{j,0,k}],Table[{0,j,0,k-2-j},{j,0,k-2}]],Join[Table[{-1,0,j,k-1-j},{j,0,k-1}],Table[{0,-1,j,k-1-j},{j,0,k-1}]],Join[Select[Flatten[Table[{-1,j,i,k-i-j-1},{i,0,k-1},{j,0,k-1}],1],#[[-1]]>=0&],Select[Flatten[Table[{0,j,i,k-i-j-2},{i,0,k-1},{j,0,k-1}],1],#[[-1]]>=0&]],Select[Flatten[Table[{j,i,m,k-i-j-m-2},{m,0,k-2},{i,0,k-2},{j,0,k-2}],2],#[[-1]]>=0&]]);
twoLoopColourings[-1][legs_]={};twoLoopColourings[k_][{1,1,0,1,1,0}]:=twoLoopColourings[k][{1,1,0,1,1,0}]=If[k==0,{{0,-1,0,-1,0},{-1,0,0,0,-1}},{}];twoLoopColourings[k_][{1,1,1,0,1,1,0}]:=twoLoopColourings[k][{1,1,1,0,1,1,0}]=Which[k===0,{{-1,0,-1,-1,0,-1,0},{-1,0,-1,0,-1,0,-1}},k===1,{{0,-1,0,0,-1,0,-1},{0,-1,0,-1,0,-1,0}},True,{}];twoLoopColourings[k_][{1,1,1,0,1,1,1,0}]:=twoLoopColourings[k][{1,1,1,0,1,1,1,0}]=Which[k===0,{{-1,0,-1,0,-1,0,-1}},k===1,{{0,-1,0,0,-1,0,-1},{-1,0,-1,0,0,-1,0}},k===2,{{0,-1,0,0,0,-1,0}},True,{}];twoLoopColourings[k_][legs_]:=If[Head[legs[[1]]]===List,twoLoopColourings[k][Length/@legs],If[Length[legs]==8&&(legs[[-1]]>0),twoLoopColourings[k][ReplacePart[legs,{4->(legs[[4]]+legs[[-1]]),-1->0}]],If[Length[legs]==6&&(legs[[-1]]>0),twoLoopColourings[k][ReplacePart[legs,{3->(legs[[3]]+legs[[-1]]),-1->0}]],twoLoopColourings[k][legs]=DeleteDuplicates[(Which[Length[legs]==7,Block[{maxLeg=Ordering[legs+{0,0,0,1,0,0,1}][[-1]]},Join[Select[twoLoopColourings[k][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]>=0&],#+Normal[SparseArray[{maxLeg->1},{7}]]&/@Select[twoLoopColourings[k-1][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]<=((legs+{0,0,0,1,0,0,1})[[maxLeg]]-3)&]]],Length[legs]==8,Block[{maxLeg=Ordering[legs+{0,0,0,1,0,0,0,0}][[-1]]},Join[Select[twoLoopColourings[k][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]>=0&],#+Normal[SparseArray[{maxLeg->1},{7}]]&/@Select[twoLoopColourings[k-1][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]<=((legs+{0,0,0,2,0,0,0,0})[[maxLeg]]-3)&]]],Length[legs]==6,Block[{maxLeg=Ordering[legs+{0,0,1,0,0,0}][[-1]]},Join[Select[twoLoopColourings[k][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]>=0&],#+Normal[SparseArray[{maxLeg->1},{5}]]&/@Select[twoLoopColourings[k-1][ReplacePart[legs,{maxLeg->legs[[maxLeg]]-1}]],#[[maxLeg]]<=((legs+{0,0,2,0,0,0})[[maxLeg]]-3)&]]]])]]]];
colouredBoxes[n_,k_,ell_:1]:=colouredBoxes[n,k,ell]=Which[ell===1,Block[{boxList=scalarBoxes[n,ell],defaultColourings=oneLoopColourings[k],nLists,rotateLists,colourRules,legs},nLists=(Length/@#&/@#&/@boxList);colourRules=Join@@(Function[{nLegs,colours},Table[Rule[legs@@j,Select[colours,Min[#1-#2&@@@DeleteCases[Transpose[{j,#}],{1,x_}]]>=2&]],{j,nLegs}]]@@@Transpose[{(DeleteDuplicates/@nLists),defaultColourings}]);DeleteCases[((Transpose/@Transpose[{boxList,legs@@@#&/@nLists}])/.colourRules),{x_,{}},2]],ell===2,{Select[({#,twoLoopColourings[k][#]}&/@(Select[scalarBoxes[n,2][[2]],Min[Length/@#[[5;;6]]]>=2&])),Length[#[[2]]]>0&],Block[{boxList=scalarBoxes[n,ell][[3]],cBoxes},cBoxes={#,twoLoopColourings[k][#]}&/@boxList;Select[cBoxes,Length[#[[2]]]>0&]]},True,{{}}];
colouredOnShellGraphs[n_,k_,ell_:1]:=colouredOnShellGraphs[n,k,ell]=Which[ell===1,Function[{legList,kChargeLists},box[legList,If[Head[kChargeLists[[1]]]===Integer,If[kChargeLists[[1]]==-1,{{kChargeLists},{}},{If[Min[Length/@legList]>1,{kChargeLists},{}],{kChargeLists}}],{If[Min[Length/@legList]>1,kChargeLists,Select[kChargeLists,#[[1]]==-1&]],Select[kChargeLists,#[[1]]>-1&]}]]]@@@((Join@@colouredBoxes[n,k,ell])),ell===2,Join[DeleteCases[(Function[{legList,kChargeLists},Block[{leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Prepend[legList[[5;;7]],Join@@(RotateRight[legList][[1;;5]])],rtns,leftKs=#[[1;;4]]&/@kChargeLists,rightKs=#[[4;;7]]&/@kChargeLists,stdBoxes,kRules},stdBoxes={RotateLeft[#,Ordering[Partition[Length/@#,4,1,1],1][[1]]-1]&@leftBox,RotateLeft[#,Ordering[Partition[Length/@#,4,1,1],1][[1]]-1]&@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]],Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]};leftKs=RotateLeft[#,rtns[[1]]-1]&/@leftKs;rightKs=RotateLeft[#,rtns[[2]]-1]&/@rightKs;kRules=Thread[Rule[Transpose[{leftKs,rightKs}],kChargeLists]];Sequence@@(kBoxes[Sequence@@#1][legList,(#2/.kRules)]&@@@Transpose[{{{1,1},{1,2},{2,1},{2,2}},{Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]==-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&&#[[2,1]]==-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]>-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&&#[[2,1]]>-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]==-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&&#[[2,1]]==-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]>-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&&#[[2,1]]>-1&]]}}])]]@@@colouredBoxes[n,k,ell][[2]]),kBoxes[__][_,{}]],DeleteCases[(Function[{legList,kChargeLists},Block[{leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Join[{(Join@@legList[[{3,4}]])[[If[Length[legList[[4]]]==0,-1,1];;-1]]},legList[[5;;6]],{(Join@@legList[[{7,1}]])[[1;;If[Length[legList[[7]]]==0,1,-1]]]}],rtns,leftKs=#[[1;;4]]&/@kChargeLists,rightKs=#[[4;;7]]&/@kChargeLists,stdBoxes,kRules},stdBoxes={RotateLeft[#,Ordering[Partition[Length/@#,4,1,1],1][[1]]-1]&@leftBox,RotateLeft[#,Ordering[Partition[Length/@#,4,1,1],1][[1]]-1]&@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]],Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]};leftKs=RotateLeft[#,rtns[[1]]-1]&/@leftKs;rightKs=RotateLeft[#,rtns[[2]]-1]&/@rightKs;kRules=Thread[Rule[Transpose[{leftKs,rightKs}],kChargeLists]];Sequence@@(pBoxes[Sequence@@#1][legList,(#2/.kRules)]&@@@Transpose[{{{1,1},{1,2},{2,1},{2,2}},{Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]==-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&&#[[2,1]]==-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]>-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]==-1&&#[[2,1]]>-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]==-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&&#[[2,1]]==-1&]],Which[Min[Min/@((Length/@#&/@stdBoxes))]>1,Transpose[{leftKs,rightKs}],Min[Length/@stdBoxes[[1]]]>1,Select[Transpose[{leftKs,rightKs}],#[[2,1]]>-1&],Min[Length/@stdBoxes[[2]]]>1,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&],True,Select[Transpose[{leftKs,rightKs}],#[[1,1]]>-1&&#[[2,1]]>-1&]]}}])]]@@@colouredBoxes[n,k,ell][[1]]),pBoxes[__][_,{}]],Block[{triangles=massiveDoubleTriangles[n]},DeleteCases[(Function[{q},Block[{colourings=twoLoopColourings[k][q]},doubleTriangle[q,colourings]]]/@triangles),doubleTriangle[_,{}]]]]];
canonicalizeLegs[legList_]:=Block[{newLegs=RotateLeft[legList,Ordering[Partition[Length/@legList,4,1,1],1][[1]]-1],n=Length[Flatten[legList]]},If[Length[newLegs[[1]]]==1||Count[newLegs,shift[__]|cap[__],{0,\[Infinity]}]>0,newLegs,Sort[newLegs,DeleteDuplicates[Join[Cases[#1,_Integer],(#1/.{X1->n+1,X2->n+2})]][[1]]<DeleteDuplicates[Join[Cases[#2,_Integer],(#2/.{X1->n+1,X2->n+2})]][[1]]&]]];padLegs[legList_]:=If[Min[Length/@legList]>1,legList[[All,{1,-1}]],Block[{newLegs=(Replace[legList,{List[x_,y___,z_]:>List[x,List[y,z][[1]],List[x,y][[-1]],z]},1])},If[Length[newLegs]==3,Join[newLegs[[1;;2]],{Join[newLegs[[3,1;;2]],{X1,X1}],Join[{X2,X2},newLegs[[3,3;;4]]]}],newLegs]]];


(*   Local Integrand Representations *)
(*   ---   On-Shell Functions & Eval *)
quadCuts[{{1},{2},{3},{4}}]={{1,1,3,3},{4,2,2,4}};quadCuts[{{1},{2},{3},{4,5}}]={{1,1,3,3},{cap[{5,1},{2,3,4}],2,2,cap[{3,4},{5,1,2}]}};quadCuts[{{1},{2,3},{4},{5,6}}]={{1,1,4,4},{cap[{6,1},{3,4,5}],cap[{1,2},{3,4,5}],cap[{3,4},{6,1,2}],cap[{4,5},{6,1,2}]}};quadCuts[{{1},{2},{3,4},{5,6}}]={{1,1,cap[{2,3},{1,4,5}],cap[{4,5},{1,2,3}]},{cap[{6,1},{2,4,5}],2,2,cap[{4,5},{6,1,2}]}};quadCuts[{{1},{2,3},{4,5},{6,7}}]={{1,1,cap[{3,4},{1,5,6}],cap[{5,6},{1,3,4}]},{cap[{7,1},{cap[{3,4},{7,1,2}],5,6}],cap[{1,2},{cap[{3,4},{7,1,2}],5,6}],cap[{3,4},{7,1,2}],cap[{5,6},{7,1,2}]}};quadCuts[{{1,2},{3,4},{5,6},{7,8}}]=Block[{\[CapitalDelta],u,v},Block[{deltaRule=Rule[\[CapitalDelta],((power[power[1-u-v,2]-4 u v,1/2]/.Thread[Rule[{u,v},{ab[8,1,2,3]ab[4,5,6,7]/(ab[8,1,4,5]ab[2,3,6,7]),ab[2,3,4,5]ab[6,7,8,1]/(ab[8,1,4,5]ab[2,3,6,7])}]]))]},shift@@@#&/@(Transpose/@Transpose[{{{{1,8},{2,3},{5,4},{6,7}},{{8,1},{3,2},{4,5},{7,6}}},(((({RotateLeft[#2],#1}&@@((Join@@({(ab[1,3,2,cap[{4,5},{6,7,8}]]+\[CapitalDelta] ab[2,3,6,7] ab[8,1,4,5]+ab[8,3,2,cap[{4,5},{6,7,1}]])Power[2 ab[1,2,3,cap[{4,5},{6,7,1}]],-1],(ab[2,4,5,cap[{7,6},{8,1,3}]]+ab[3,4,5,cap[{7,6},{8,1,2}]]+\[CapitalDelta] ab[2,3,6,7] ab[8,1,4,5])Power[2 ab[2,4,5,cap[{6,7},{8,1,2}]],-1]}/.{{},{ab[x__]:>(ab@@({x}/.{q_Integer:>Mod[q+4,8,1]}))}}))/.{{},{ab[x__]:>(ab@@{x}/.{q_Integer:>Mod[q-2,8,1]})}}))/.deltaRule)))}])]];quadCuts[legList_]:=Block[{reducedLegs=DeleteDuplicates[#[[{1,-1}]]]&/@canonicalizeLegs[legList],relabelRules},relabelRules=Thread[Rule[Flatten[reducedLegs],Range[Length[Flatten[reducedLegs]]]]];(quadCuts[(reducedLegs/.relabelRules)]/.Prepend[(Reverse/@relabelRules),shift[x_,y_]:>(shift[(x/.(Reverse/@relabelRules)),(y/.{ab[q__]:>ab@@({q}/.(Reverse/@relabelRules))})])])];
octaCut[num_,num2_:0][legList_]:=Which[Length[legList]==8,(Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),8->Join@@(legList[[{8,1,7,8}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],8->If[Length[legList[[8]]]==0,{},reducedLegs[[8]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-8]]&/@Range[8]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];(octaCut[num,num2][canonicalLegs]/.{shift[q_,r_]:>shift[(q/.relabelRules),(r/.{ab[x__]:>ab@@({x}/.relabelRules)})],ab[x__]:>ab@@({x}/.relabelRules),q_Integer:>(q/.relabelRules)})]),(Block[{nums=({num,num2}),leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Prepend[legList[[5;;7]],Join@@(RotateRight[legList][[1;;5]])],rtns,stdBoxes},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]]-1,Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]-1};Set[octaCut[num,num2][legList],RotateLeft[Join[RotateRight[quadCuts[stdBoxes[[1]]][[nums[[1]]]],rtns[[1]]],RotateRight[quadCuts[stdBoxes[[2]]][[nums[[2]]]],rtns[[2]]-1]],0]]])]]),Length[legList]==7,(Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),7->Join@@(legList[[{7,1,6,7}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],7->If[Length[legList[[7]]]==0,{},reducedLegs[[7]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-7]]&/@Range[7]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];(octaCut[num,num2][canonicalLegs]/.{shift[q_,r_]:>shift[(q/.relabelRules),(r/.{ab[x__]:>ab@@({x}/.relabelRules)})],ab[x__]:>ab@@({x}/.relabelRules),q_Integer:>(q/.relabelRules)})]),(Block[{nums=({num,num2}),leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Join[{Prepend[legList[[4]],legList[[3,-1]]]},legList[[5;;6]],{Append[legList[[7]],legList[[1,1]]]}],cutProps,rtns,stdBoxes},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]]-1,Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]-1};cutProps=RotateRight[quadCuts[stdBoxes[[1]]][[nums[[1]]]],rtns[[1]]];stdBoxes=ReplacePart[stdBoxes,2->(stdBoxes[[2]]/.Thread[Rule[{legList[[3,-1]],legList[[1,1]]},cutProps[[{-1,1}]]]])];cutProps=Join[cutProps,(RotateRight[quadCuts[stdBoxes[[2]]][[nums[[2]]]],(rtns[[2]]+Flatten[Position[Partition[stdBoxes[[2]],4,1,1],canonicalizeLegs[stdBoxes[[2]]]]][[1]]-1-1)])];Set[octaCut[num,num2][legList],cutProps]])]])];
boxRs[{{1},{2},{3},{4}}]={1,1};boxRs[{{1},{2},{3},{4,5}}]={1,R[1,2,3,4,5]};boxRs[{{1},{2,3},{4},{5,6}}]={1,R[1,cap[{3,4},{6,1,2}],4,5,6] R[1,2,3,4,cap[{6,1},{3,4,5}]]};boxRs[{{1},{2},{3,4},{5,6}}]={R[1,2,3,4,5],R[1,2,4,5,6]};boxRs[{{1},{2,3},{4,5},{6,7}}]={R[1,3,4,5,6],R[cap[{1,2},{5,6,7}],2,3,4,cap[{5,6},{7,1,2}]]R[1,2,5,6,7]};boxRs[{{1,2},{3,4},{5,6},{7,8}}]=Block[{cuts=quadCuts[{{1,2},{3,4},{5,6},{7,8}}],prefactors},(({Power[1-(ab[cuts[[1,2]],7,8,1]ab[cuts[[1,4]],3,4,5])/(ab[cuts[[1,2]],7,4,5]ab[cuts[[1,4]],3,8,1]),-1],Power[1-(ab[cuts[[2,1]],5,6,7]ab[cuts[[2,3]],1,2,3])/(ab[cuts[[2,1]],5,2,3]ab[cuts[[2,3]],1,6,7]),-1]}*{R[cuts[[1,4]],8,1,2,3]R[cuts[[1,2]],4,5,6,7],R[cuts[[2,1]],2,3,4,5]R[cuts[[2,3]],6,7,8,1]}))];boxRs[legList_]/;(Length[legList]==4):=Block[{reducedLegs=DeleteDuplicates[#[[{1,-1}]]]&/@canonicalizeLegs[legList],relabelRules},relabelRules=Thread[Rule[Flatten[reducedLegs],Range[Length[Flatten[reducedLegs]]]]];((boxRs[(reducedLegs/.relabelRules)]/.{ab[q__]:>ab@@({q}/.Prepend[(Reverse/@relabelRules),shift[x_,y_]:>(shift[(x/.(Reverse/@relabelRules)),(y/.{ab[q1__]:>ab@@({q1}/.(Reverse/@relabelRules))})])])}/.{R[x___,shift[y_,z_],w___]:>(R@@Join[({x}/.(Reverse/@relabelRules)),{shift[(y/.(Reverse/@relabelRules)),z]},({w}/.(Reverse/@relabelRules))]),R[x___]:>(R@@({x}/.(Reverse/@relabelRules)))}))];
onShellFunction[num_,num2_:0][legList_,kChargeList_]:=Which[Length[legList]==4,(Block[{cutProps=quadCuts[legList][[num]],cutRs=boxRs[legList][[num]],cornerRules,cornerAmps},cornerRules=(Thread/@(Rule@@@(Transpose[{(Range[2+Length[#]]&/@legList),(RotateRight/@(Join@@@Transpose[{legList,Reverse/@Partition[#,2,1,1]}]))}])))&@(cutProps);((Times@@@Tuples[Append[((rAmp[#1+2,#2]/.{R[x__]:>(R@@({x}/.#3))})&@@@Transpose[{Length/@legList,kChargeList,cornerRules}]),{cutRs}]]))]),Length[legList]==8,(Block[{reducedKs=Min[#,0]&/@kChargeList},If[Not[reducedKs===kChargeList],(Block[{reducedLegs,stripped=onShellFunction[num,num2][legList,reducedKs],cornerRules,cutProps},cutProps=octaCut[num,num2][legList];cornerRules=(Thread[Rule[Range[Length[#]],#]]&/@((ReplacePart[#,{4->Join[#[[4]],#[[-1]]]}][[1;;-2]]&@((RotateRight/@(Join@@@Transpose[{legList,Reverse/@Partition[cutProps,2,1,1]}]))))));((Times@@@Tuples[Append[((rAmp[(Length[#2]),#1]/.{R[x__]:>(R@@({x}/.#2))})&@@@Transpose[{kChargeList,cornerRules}]),stripped]]))]),Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),8->Join@@(legList[[{8,1,7,8}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],8->If[Length[legList[[8]]]==0,{},reducedLegs[[8]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-8]]&/@Range[8]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules,q1,q2,q21,q4},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];((((onShellFunction[num,num2][canonicalLegs,kChargeList]//.{(1-eph_):>(q1-eph),Rational[1,2]->q21,Power[eph_,2]:>Power[eph,q2],power[eph_,2]:>power[eph,q2],Times[-4,eph_]:>Times[q4,eph]})/.{ab[x___]:>ab@@({x}/.relabelRules),R[x___]:>R@@({x}/.relabelRules)}))/.Thread[Rule[{q1,q2,q21,q4},{1,2,1/2,-4}]])]),(Block[{nums=({num,num2}),leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Prepend[legList[[5;;7]],Join@@(RotateRight[legList][[1;;5]])],rightRules,rtns,stdBoxes,cutProps=octaCut[num,num2][legList]},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]]-1,Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]-1};rightRules=Thread[Rule[{legList[[1,1]],legList[[3,-1]]},cutProps[[{1,4}]]]];Set[onShellFunction[num,num2][legList,kChargeList],{(boxRs[stdBoxes[[1]]][[nums[[1]]]]((boxRs[stdBoxes[[2]]][[nums[[2]]]]/.{ab[q__]:>ab@@({q}/.Prepend[(rightRules),shift[x_,y_]:>(shift[(x/.(rightRules)),(y/.{ab[q1__]:>ab@@({q1}/.(rightRules))})])])})/.{R[x___,shift[y_,z_],w___]:>(R@@Join[({x}/.rightRules),{shift[(y/.rightRules),z]},({w}/.rightRules)]),R[x___]:>(R@@({x}/.rightRules))}))}]])]]]]),Length[legList]==7,(Block[{reducedKs=Min[#,0]&/@kChargeList},If[Not[reducedKs===kChargeList],(Block[{stripped=onShellFunction[num,num2][legList,reducedKs],cornerRules,cutProps=octaCut[num,num2][legList]},cornerRules=(Thread[Rule[Range[Length[#]],#]]&/@(ReplacePart[#,{4->Prepend[#[[4]],cutProps[[-1]]],7->Append[#[[7]],cutProps[[-1]]]}]&@((((RotateRight/@(Join@@@Transpose[{legList,Reverse/@Partition[cutProps[[1;;-2]],2,1,1]}])))))));((Times@@@Tuples[Append[((rAmp[(Length[#2]),#1]/.{R[x__]:>(R@@({x}/.#2))})&@@@Transpose[{kChargeList,cornerRules}]),stripped]]))]),Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),7->Join@@(legList[[{7,1,6,7}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],7->If[Length[legList[[7]]]==0,{},reducedLegs[[7]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-7]]&/@Range[7]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules,q1,q2,q21,q4},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];((((onShellFunction[num,num2][canonicalLegs,kChargeList]//.{(1-eph_):>(q1-eph),Rational[1,2]->q21,Power[eph_,2]:>Power[eph,q2],power[eph_,2]:>power[eph,q2],Times[-4,eph_]:>Times[q4,eph]})/.{ab[x___]:>ab@@({x}/.relabelRules),R[x___]:>R@@({x}/.relabelRules)}))/.Thread[Rule[{q1,q2,q21,q4},{1,2,1/2,-4}]])]),(Block[{nums=({num,num2}),leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Join[{Prepend[legList[[4]],legList[[3,-1]]]},legList[[5;;6]],{Append[legList[[7]],legList[[1,1]]]}],rightRules,rtns,stdBoxes,cutProps=octaCut[num,num2][legList]},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]]-1,Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]-1};stdBoxes=ReplacePart[stdBoxes,2->(stdBoxes[[2]]/.Thread[Rule[{legList[[3,-1]],legList[[1,1]]},cutProps[[{4,1}]]]])];Set[onShellFunction[num,num2][legList,kChargeList],{(boxRs[stdBoxes[[1]]][[nums[[1]]]]((boxRs[stdBoxes[[2]]][[nums[[2]]]])))}]])]]]]),Length[legList]==6,(Block[{base=onShellFunction[1,1][{legList[[1,{1}]],legList[[1,2;;-1]],legList[[2]],legList[[3]],legList[[4,{1}]],legList[[4,2;;-1]],legList[[5]],legList[[6]]},{-1,0,kChargeList[[2]],kChargeList[[3]],-1,0,kChargeList[[5]]}],cutPts={shift[{legList[[1,1]],Join[legList[[5]],legList[[-1]]][[-1]]},(ab[legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[-2,1]],legList[[1,1]]]/ab[Join[legList[[5]],legList[[-1]]][[-1]],legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[-2,1]]])],shift[{legList[[4,1]],Join[legList[[2]],legList[[3]]][[-1]]},(ab[legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]],legList[[4,1]]]/ab[Join[legList[[2]],legList[[3]]][[-1]],legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]]])]},cornerRules={Thread[Rule[Range[Length[legList[[1]]]+2],RotateRight[Join[legList[[1]],{cap[{legList[[1,-1]],legList[[2,1]]},{legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[5,1]]}],cap[{legList[[1,1]],Join[legList[[5]],legList[[-1]]][[-1]]},{legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[5,1]]}]}]]]],Thread[Rule[Range[Length[legList[[4]]]+2],RotateRight[Join[legList[[4]],{cap[{legList[[4,-1]],legList[[5,1]]},{legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]]}],cap[{legList[[4,1]],Join[legList[[2]],legList[[3]]][[-1]]},{legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]]}]}]]]]},cornerAmps={{Length[legList[[1]]]+2,kChargeList[[1]]},{Length[legList[[4]]]+2,kChargeList[[4]]}}},base=((base/.{R[x___]:>R@@({x}/.{legList[[1,1]]->cutPts[[1]]})})/.{R[x___]:>R@@({x}/.{legList[[4,1]]->cutPts[[2]]})});cutPts={cutPts[[1]],cap[{Join[legList[[3]],legList[[4]]][[1]],legList[[2,-1]]},{legList[[1,-1]],legList[[2,1]],cutPts[[1]]}],cutPts[[2]],cap[{Join[legList[[-1]],legList[[1]]][[1]],legList[[-2,-1]]},{legList[[4,-1]],legList[[5,1]],cutPts[[2]]}]};(Times@@@Tuples[{base,(rAmp[Length[legList[[1]]]+2,kChargeList[[1]]]/.{R[x__]:>(R@@({x}/.cornerRules[[1]]))}),(rAmp[Length[legList[[4]]]+2,kChargeList[[4]]]/.{R[x__]:>(R@@({x}/.cornerRules[[2]]))})}])]),True,0];


(*   Local Integrand Representations *)
(*   ---   Cut-Matching Integrands   *)
scalarBoxIntegrand[{{1},{2},{3,4}}]:=Block[{num=ab[4,1,2,3]ab[X1,X2,1,2],denom=Times@@(ab[A,B,##]&@@@{{1,2},{2,3},{4,1},{X1,X2}})},num/denom];scalarBoxIntegrand[{{1},{2},{3},{4}}]:=Block[{num=ab[1,2,3,4]ab[2,3,4,1],denom=Times@@(ab[A,B,##]&@@@Partition[Range[4],2,1,1])},num/denom];scalarBoxIntegrand[{{1},{2},{3},{4,5}}]:=Block[{num=(ab[5,1,2,3]ab[1,2,3,4]),denom=Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{3,4},{5,1}])},num/denom];scalarBoxIntegrand[{{1},{2,3},{4},{5,6}}]:=Block[{num=(ab[6,1,2,4]ab[1,3,4,5]),denom=Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{4,5},{6,1}])},num/denom];scalarBoxIntegrand[{{1},{2},{3,4},{5,6}}]:=Block[{num=(ab[6,1,2,3]ab[1,2,4,5]),denom=(Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{4,5},{6,1}]))},num/denom];scalarBoxIntegrand[{{1},{2,3},{4,5},{6,7}}]:=Block[{num=-ab[7,cap[{1,3,4},{5,6,1}],2],denom=(Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{5,6},{7,1}]))},num/denom];scalarBoxIntegrand[{{1,2},{3,4},{5,6},{7,8}}]:=Block[{propList={{8,1},{2,3},{4,5},{6,7}},u=ab[8,1,2,3]ab[4,5,6,7]/(ab[8,1,4,5]ab[2,3,6,7]),v=ab[2,3,4,5]ab[6,7,8,1]/(ab[8,1,4,5]ab[2,3,6,7]),\[CapitalDelta],even,odd,denom,num},\[CapitalDelta]=power[power[1-u-v,2]-4 u v,1/2];denom=(Times@@(ab[A,B,##]&@@@propList));num=(ab[8,1,4,5]ab[2,3,6,7]\[CapitalDelta]);num/denom];scalarBoxIntegrand[legList_]:=Block[{reducedLegs=DeleteDuplicates[#[[{1,-1}]]]&/@canonicalizeLegs[legList],relabelRules},relabelRules=Thread[Rule[Flatten[reducedLegs],Range[Length[Flatten[reducedLegs]]]]];((scalarBoxIntegrand[(reducedLegs/.relabelRules)]/.{ab[q__]:>ab@@({q}/.(Reverse/@relabelRules))}))];scalarTriangleIntegrands[1][{{1},{2},{3,4},{5,6}}]:=((ab[X1,X2,4,5] ab[6,1,2,3]-ab[X1,X2,2,3] ab[4,5,6,1]-ab[X1,X2,6,1]ab[2,3,4,5])/(ab[A,B,X1,X2] ab[A,B,2,3] ab[A,B,4,5] ab[A,B,6,1]));scalarTriangleIntegrands[2][{{1},{2,3},{4,5},{6,7}}]:=(((ab[X1,X2,5,6]ab[7,1,3,4]-0ab[X1,X2,7,1]ab[3,4,5,6]-ab[X1,X2,3,4]ab[5,6,7,1]))/(ab[A,B,X1,X2] ab[A,B,3,4] ab[A,B,5,6] ab[A,B,7,1]));scalarTriangleIntegrands[3][{{1},{2,3},{4,5},{6,7}}]:=(((ab[X1,X2,3,4]ab[1,2,5,6]-0ab[X1,X2,1,2]ab[3,4,5,6]-ab[X1,X2,5,6]ab[1,2,3,4]))/(ab[A,B,X1,X2]ab[A,B,1,2] ab[A,B,3,4] ab[A,B,5,6]));scalarTriangleIntegrand[legList_]:=If[Min[Length/@DeleteCases[legList,X1|X2,{0,\[Infinity]}]]>1,scalarBoxIntegrand[legList],Block[{newLegs=DeleteDuplicates[#[[{1,-1}]]]&/@(DeleteCases[legList,X1|X2,{0,\[Infinity]}]),type,relabelRules},newLegs=RotateLeft[newLegs,Ordering[Partition[Length/@newLegs,4,1,1],1][[1]]-1];relabelRules=Thread[Rule[Range[Length[Flatten[newLegs]]],Flatten[newLegs]]];type=Which[Count[Length/@newLegs,1]==2,1,MemberQ[legList,{newLegs[[1,1]],X1}],2,True,3];(scalarTriangleIntegrands[type][(newLegs/.(Reverse/@relabelRules))]/.{ab[x__]:>ab@@({x}/.relabelRules)})]];
(*chiralBoxIntegrands[{{1},{2},{3},{4}}]:=Block[{num=ab[1,2,3,4]ab[2,3,4,1],denom=Times@@(ab[A,B,##]&@@@Partition[Range[4],2,1,1])},{num/denom,num/denom}];chiralBoxIntegrands[{{1},{2},{3},{4,5}}]:=Block[{num={ab[X1,X2,1,3]ab[A,B,cap[{5,1,2},{2,3,4}]],ab[A,B,1,3]ab[X1,X2,cap[{5,1,2},{2,3,4}]]},denom=Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{3,4},{5,1},{X1,X2}])},num/denom];chiralBoxIntegrands[{{1},{2,3},{4},{5,6}}]:=Block[{num={ab[X1,X2,1,4]ab[A,B,cap[{6,1,2},{3,4,5}]],ab[A,B,1,4]ab[X1,X2,cap[{6,1,2},{3,4,5}]]},denom=Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{4,5},{6,1},{X1,X2}])},num/denom];chiralBoxIntegrands[{{1},{2},{3,4},{5,6}}]:=Block[{num={ab[X1,X2,dif[{cap[{1,2,3},{4,5,cap[{6,1},{A,B,2}]}]},{cap[{1,4,5},{2,3,cap[{6,1},{A,B,2}]}]}]],ab[X1,X2,dif[{cap[{4,5,2},{6,1,cap[{2,3},{A,B,1}]}]},{cap[{6,1,2},{4,5,cap[{2,3},{A,B,1}]}]}]]},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{4,5},{6,1},{X1,X2}]))},num/denom];chiralBoxIntegrands[{{1},{2,3},{4,5},{6,7}}]:=Block[{num={ab[X1,X2,dif[{cap[{1,3,4},{5,6,cap[{7,1,2},{A,B}]}]},{cap[{1,5,6},{3,4,cap[{7,1,2},{A,B}]}]}]],ab[X1,X2,dif[{cap[{3,4},{7,1,2}],cap[{5,6},{A,B,1}]},{cap[{5,6},{7,1,2}],cap[{3,4},{A,B,1}]}]]},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{5,6},{7,1},{X1,X2}]))},num/denom];chiralBoxIntegrands[{{1,2},{3,4},{5,6},{7,8}}]:=Block[{propList={{8,1},{2,3},{4,5},{6,7}},u=ab[8,1,2,3]ab[4,5,6,7]/(ab[8,1,4,5]ab[2,3,6,7]),v=ab[2,3,4,5]ab[6,7,8,1]/(ab[8,1,4,5]ab[2,3,6,7]),\[CapitalDelta],even,odd,denom,num},\[CapitalDelta]=power[power[1-u-v,2]-4 u v,1/2];denom=(Times@@(ab[A,B,##]&@@@Append[propList,{X1,X2}]));odd=Total[(Signature[{##}[[All,-1]]](ab[X1,X2,cap[#1,Append[#2,6]],cap[#3,Append[#4,7]]]))&@@@Permutations[{{8,1},{2,3},{4,5},{A,B}}]]/12;even=(ab[A,B,X1,X2]ab[8,1,4,5]ab[2,3,6,7]\[CapitalDelta]/2);num={(even-odd),(even+odd)};num/denom];chiralBoxIntegrands[legList_]:=Block[{reducedLegs=DeleteDuplicates[#[[{1,-1}]]]&/@canonicalizeLegs[legList],relabelRules},relabelRules=Thread[Rule[Flatten[reducedLegs],Range[Length[Flatten[reducedLegs]]]]];((chiralBoxIntegrands[(reducedLegs/.relabelRules)]/.{ab[q__]:>ab@@({q}/.(Reverse/@relabelRules))}))];*)
chiralBoxIntegrands[{{1},{2},{3},{4}}]:=Block[{num=ab[1,2,3,4]ab[2,3,4,1],denom=Times@@(ab[A,B,##]&@@@Partition[Range[4],2,1,1])},{num/denom,num/denom}];chiralBoxIntegrands[{{1},{2},{3},{4,5}}]:=Block[{num={ab[X1,X2,1,3]ab[A,B,cap[{5,1,2},{2,3,4}]],ab[A,B,1,3]ab[X1,X2,cap[{5,1,2},{2,3,4}]]},denom=Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{3,4},{5,1},{X1,X2}])},num/denom];chiralBoxIntegrands[{{1},{2,3},{4},{5,6}}]:=Block[{num={ab[X1,X2,1,4]ab[A,B,cap[{6,1,2},{3,4,5}]],ab[A,B,1,4]ab[X1,X2,cap[{6,1,2},{3,4,5}]]},denom=Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{4,5},{6,1},{X1,X2}])},num/denom];(*chiralBoxIntegrands[{{1},{2},{3,4},{5,6}}]:=Block[{num={ab[X1,X2,dif[{cap[{1,2,3},{4,5,cap[{6,1},{A,B,2}]}]},{cap[{1,4,5},{2,3,cap[{6,1},{A,B,2}]}]}]],ab[X1,X2,dif[{cap[{4,5,2},{6,1,cap[{2,3},{A,B,1}]}]},{cap[{6,1,2},{4,5,cap[{2,3},{A,B,1}]}]}]]},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{4,5},{6,1},{X1,X2}]))},num/denom];*)chiralBoxIntegrands[{{1},{2},{3,4},{5,6}}]:=Block[{num={ab[A,B,cap[{6,1},{3,4,5}],2] ab[X1,X2,1,2]+ab[A,B,2,cap[{6,1},{2,4,5}]] ab[X1,X2,1,3]+ab[A,B,cap[{6,1},{3,2,5}],2] ab[X1,X2,1,4]+ab[A,B,cap[{6,1},{2,3,4}],2] ab[X1,X2,1,5]-ab[6,1,4,5] ab[A,B,1,2] ab[X1,X2,2,3]+ab[6,1,2,3] ab[A,B,1,2] ab[X1,X2,4,5],ab[X1,X2,4,5]ab[2,3,6,1]ab[A,B,1,2]+ab[X1,X2,2,5]ab[A,B,1,cap[{2,3},{4,6,1}]]+ab[X1,X2,2,4]ab[A,B,cap[{2,3},{5,6,1}],1]-(ab[X1,X2,6,1]ab[2,3,4,5]ab[A,B,1,2]+ab[X1,X2,2,1]ab[A,B,1,cap[{2,3},{6,4,5}]]+ab[X1,X2,2,6]ab[A,B,cap[{2,3},{1,4,5}],1])},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{2,3},{4,5},{6,1},{X1,X2}]))},num/denom];(*chiralBoxIntegrands[{{1},{2,3},{4,5},{6,7}}]:=Block[{num={ab[X1,X2,dif[{cap[{1,3,4},{5,6,cap[{7,1,2},{A,B}]}]},{cap[{1,5,6},{3,4,cap[{7,1,2},{A,B}]}]}]],ab[X1,X2,dif[{cap[{3,4},{7,1,2}],cap[{5,6},{A,B,1}]},{cap[{5,6},{7,1,2}],cap[{3,4},{A,B,1}]}]]},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{5,6},{7,1},{X1,X2}]))},num/denom];*)chiralBoxIntegrands[{{1},{2,3},{4,5},{6,7}}]:=Block[{num={ab[X1,X2,1,3]ab[A,B,cap[{4,5,6},{7,1,2}]]+ab[X1,X2,3,4]ab[A,B,cap[{1,5,6},{7,1,2}]]+ab[X1,X2,4,1]ab[A,B,cap[{3,5,6},{7,1,2}]]-(ab[X1,X2,1,5]ab[A,B,cap[{6,3,4},{7,1,2}]]+ab[X1,X2,5,6]ab[A,B,cap[{1,3,4},{7,1,2}]]+ab[X1,X2,6,1]ab[A,B,cap[{5,3,4},{7,1,2}]]),ab[X1,X2,5,cap[{3,4},{7,1,2}]]ab[A,B,1,6]+ab[X1,X2,cap[{3,4},{7,1,2}],6]ab[A,B,1,5]-(ab[X1,X2,3,cap[{5,6},{7,1,2}]]ab[A,B,1,4]+ab[X1,X2,cap[{5,6},{7,1,2}],4]ab[A,B,1,3])},denom=2(Times@@(ab[A,B,##]&@@@List[{1,2},{3,4},{5,6},{7,1},{X1,X2}]))},num/denom];chiralBoxIntegrands[{{1,2},{3,4},{5,6},{7,8}}]:=Block[{propList={{8,1},{2,3},{4,5},{6,7}},u=ab[8,1,2,3]ab[4,5,6,7]/(ab[8,1,4,5]ab[2,3,6,7]),v=ab[2,3,4,5]ab[6,7,8,1]/(ab[8,1,4,5]ab[2,3,6,7]),\[CapitalDelta],even,odd,denom,num},\[CapitalDelta]=power[power[1-u-v,2]-4 u v,1/2];denom=(Times@@(ab[A,B,##]&@@@Append[propList,{X1,X2}]));odd=Total[(Signature[{##}[[All,-1]]](ab[X1,X2,cap[#1,Append[#2,6]],cap[#3,Append[#4,7]]]))&@@@Permutations[{{8,1},{2,3},{4,5},{A,B}}]]/12;odd=Expand[Expand[((odd/.{ab[x___,cap[{A,B},{q1_,q2_,q3_}],y___]:>(-(ab[x,q1,y]ab[A,B,q2,q3]+ab[x,q2,y]ab[A,B,q3,q1]+ab[x,q3,y]ab[A,B,q1,q2]))})/.{ab[x___,cap[{r1_,r2_},{A,B,s_}],y___]:>-ab[x,r1,y]ab[A,B,s,r2]+ab[x,r2,y]ab[A,B,s,r1]})]/.{ab[A,B,x__]:>Signature[{x}]ab[A,B,Sequence@@Sort[{x}]],ab[X1,X2,x__]:>Signature[{x}]ab[X1,X2,Sequence@@Sort[{x}]]}];even=(ab[A,B,X1,X2]ab[8,1,4,5]ab[2,3,6,7]\[CapitalDelta]/2);num={(even-odd),(even+odd)};num/denom];chiralBoxIntegrands[legList_]:=Block[{reducedLegs=DeleteDuplicates[#[[{1,-1}]]]&/@canonicalizeLegs[legList],relabelRules},relabelRules=Thread[Rule[Flatten[reducedLegs],Range[Length[Flatten[reducedLegs]]]]];((chiralBoxIntegrands[(reducedLegs/.relabelRules)]/.{ab[q__]:>ab@@({q}/.(Reverse/@relabelRules))}))];
mergerRule={merge[box1_,box2_]:>Block[{ints,output,testOutput,nonMerged},ints=Together/@((({box1,box2}/.{chiralBox[num_][legList_]:>chiralBoxIntegrands[legList][[num]],scalarBox[legList_]:>scalarBoxIntegrand[legList],scalarTriangle[legList_]:>scalarTriangleIntegrand[legList]})//.{})//.{});ints={(ab[A,B,X1,X2]*ints[[1]]),((((ab[A,B,X1,X2]*ints[[2]]))/.{ab[x__]:>ab@@({x}/.Thread[Rule[{A,B},{C,D}]])}))};output=(tr@@((Expand/@(Numerator/@ints)))/(Times@@(Denominator/@ints))/ab[A,B,C,D]);output=((((output//.{tr[x_,y_]:>Which[Head[x]===Plus,Total[tr[#,y]&/@(List@@x)],Head[y]===Plus,Total[tr[x,#]&/@(List@@y)],True,tr[x,y]]}))/.tr[x_,y_]:>If[LeafCount[x]>LeafCount[y],tr[y,x],tr[x,y]])/.{tr[Times[q1___,ab[y1___,X1,X2,y2___],q2___],Times[Q1___,ab[Y1___,X1,X2,Y2___],Q2___]]:>(Block[{dual1={y2,y1},dual2={Y2,Y1}},Times@@{((Times[q1,q2])/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual2,r2]}),(Times[Q1,Q2]/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual1,r2]}),ab[y1,y2,Y1,Y2]}]),tr[ab[y1___,X1,X2,y2___],s___]:>(Block[{dual={y2,y1}},(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]),tr[s___,ab[y1___,X1,X2,y2___]]:>(Block[{dual={y2,y1}},(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]),tr[Times[q1___,ab[y1___,X1,X2,y2___],q2___],s___]:>(Block[{dual={y2,y1}},Times[q1,q2,(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]])});output],mergePentaBox[box1_,box2_]:>Block[{ints,output,testOutput,nonMerged,cuts=(box1/.chiralBox[num_][legList_]:>quadCuts[legList][[num,{1,3}]])},ints=Together/@((({box1,box2}/.{chiralBox[num_][legList_]:>chiralBoxIntegrands[legList][[num]],scalarBox[legList_]:>scalarBoxIntegrand[legList],scalarTriangle[legList_]:>scalarTriangleIntegrand[legList]})//.{})//.{});ints={(ab[A,B,X1,X2]*ints[[1]]),((((ab[A,B,X1,X2]*ints[[2]]))/.{ab[x__]:>ab@@({x}/.Thread[Rule[{A,B},{C,D}]])}))};output=(tr@@((Expand/@(Numerator/@ints)))/(Times@@(Denominator/@ints))/ab[A,B,C,D]);output=((((output//.{tr[x_,y_]:>Which[Head[x]===Plus,Total[tr[#,y]&/@(List@@x)],Head[y]===Plus,Total[tr[x,#]&/@(List@@y)],True,tr[x,y]]})))/.{tr[Times[q1___,ab[y1___,X1,X2,y2___],q2___],Times[Q1___,ab[Y1___,X1,X2,Y2___],Q2___]]:>(Block[{dual1={y2,y1},dual2={Y2,Y1}},Times@@{((Times[q1,q2])/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual2,r2]}),(Times[Q1,Q2]/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@cuts,r2]}),ab[y1,y2,Y1,Y2]}]),tr[ab[y1___,X1,X2,y2___],Times[Q1___,ab[Y1___,X1,X2,Y2___],Q2___]]:>(Block[{dual1={y2,y1},dual2={Y2,Y1}},Times@@{(Times[Q1,Q2]/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@cuts,r2]}),ab[y1,y2,Y1,Y2]}]),tr[ab[y1___,X1,X2,y2___],s___]:>(Block[{dual={y2,y1}},(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]),tr[s___,ab[y1___,X1,X2,y2___]]:>(Block[{dual={y2,y1}},(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]),tr[Times[q1___,ab[y1___,X1,X2,y2___],q2___],s___]:>(Block[{dual={y2,y1}},Times[q1,q2,(s/.{ab[r1___,X1,X2,r2___]:>ab[r1,Sequence@@dual,r2]})]])});output]};
hexaCutPointFix[int_][legs_]:=If[(Min[Length/@legs[[{1,2,4,5}]]]<2),0,(Block[{ephInt=Together[int],props=Append[Join@@({ab[A,B,##]&@@@#[[1;;3]],ab[C,D,##]&@@@#[[4;;-1]]}&@(RotateRight[{#1[[-1]],#2[[1]]}&@@@Partition[ReplacePart[legs,{3->Join[legs[[3]],legs[[4]],legs[[2]],legs[[3]]],6->Join[legs[[6]],legs[[1]],legs[[5]],legs[[6]]]}],2,1,1]])),ab[A,B,C,D]],cutPoint,wLegs={legs[[1,{1,-1}]],legs[[2,{1,-1}]],Join[legs[[3]],legs[[4]],legs[[2]],legs[[3]]][[{1,-1}]],legs[[4,{1,-1}]],legs[[5,{1,-1}]],Join[legs[[6]],legs[[1]],legs[[5]],legs[[6]]][[{1,-1}]]}},cutPoint={cap[{wLegs[[1,1]],wLegs[[-1,-1]]},{wLegs[[2,-1]],wLegs[[3,1]],wLegs[[5,1]]}],cap[{wLegs[[1,-1]],wLegs[[2,1]]},{wLegs[[2,-1]],wLegs[[3,1]],wLegs[[5,1]]}],cap[{wLegs[[4,1]],wLegs[[3,-1]]},{wLegs[[-2,-1]],wLegs[[-1,1]],wLegs[[2,1]]}],cap[{wLegs[[4,-1]],wLegs[[5,1]]},{wLegs[[-2,-1]],wLegs[[-1,1]],wLegs[[2,1]]}]};Power[Times@@props,-1]((Factor[(ephInt*Times@@props)]/.{ab[x___]:>ab@@({x}/.Thread[Rule[{A,B,C,D},cutPoint]])}))])];
chiralIntegrand[num_,num2_:0][legList_]:=Which[Length[legList]==4,(chiralBoxIntegrands[legList][[num]]),Length[legList]==8,(Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),8->Join@@(legList[[{8,1,7,8}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],8->If[Length[legList[[8]]]==0,{},reducedLegs[[8]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-8]]&/@Range[8]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];(chiralIntegrand[num,num2][canonicalLegs]/.{ab[q__]:>ab@@({q}/.Prepend[(relabelRules),shift[x_,y_]:>(shift[(x/.(relabelRules)),(y/.{ab[q1__]:>ab@@({q1}/.(relabelRules))})])])})]),(Block[{nums=({num,num2}),merged,leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Prepend[legList[[5;;7]],Join@@(RotateRight[legList][[1;;5]])],rtns,stdBoxes,hexaCutPoint},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};rtns={Flatten[Position[Partition[leftBox,4,1,1],stdBoxes[[1]]]][[1]]-1,Flatten[Position[Partition[rightBox,4,1,1],stdBoxes[[2]]]][[1]]-1};merged=(merge[chiralBox[nums[[1]]][stdBoxes[[1]]],chiralBox[nums[[2]]][stdBoxes[[2]]]]/.mergerRule);hexaCutPoint=Total[(((hexaCutPointFix[merged][#]&/@((Join@@legList[[#]])&/@#&/@List[{{1},{2},{3,4,5},{6},{7},{8}},{{1},{2},{3,4},{5,6},{7},{8}},{{1},{2},{3,4},{5},{6,7},{8}},{{1},{2},{3,4},{5},{6},{7,8}},{{1},{2,3},{4,5},{6},{7},{8}},{{1},{2,3},{4},{5,6},{7},{8}},{{1},{2,3},{4},{5},{6,7},{8}},{{1},{2,3},{4},{5},{6},{7,8}},{{1,2},{3},{4,5},{6},{7},{8}},{{1,2},{3},{4},{5,6},{7},{8}},{{1,2},{3},{4},{5},{6,7},{8}},{{1,2},{3},{4},{5},{6},{7,8}},{{2},{3},{4,5},{6},{7},{8,1}},{{2},{3},{4},{5,6},{7},{8,1}},{{2},{3},{4},{5},{6,7},{8,1}},{{2},{3},{4},{5},{6},{7,8,1}}]))))];Set[chiralIntegrand[num,num2][legList],merged-hexaCutPoint]])]]),Length[legList]==7,Block[{reducedLegs=(DeleteDuplicates[#[[{1,-1}]]]&/@ReplacePart[legList,{4->Join@@(legList[[{4,5,3,4}]]),7->Join@@(legList[[{7,1,6,7}]])}]),lens,canonicalLegs},reducedLegs=ReplacePart[reducedLegs,{4->If[Length[legList[[4]]]==0,{},reducedLegs[[4]]],7->If[Length[legList[[7]]]==0,{},reducedLegs[[7]]]}];lens=Length/@reducedLegs;canonicalLegs=Range[#1+1,#2]&@@@Partition[Prepend[(Total[Drop[lens,#-7]]&/@Range[7]),0],2,1];If[Not[Flatten[canonicalLegs]===Flatten[reducedLegs]],(Block[{relabelRules},relabelRules=Thread[Rule[Flatten[canonicalLegs],Flatten[reducedLegs]]];(chiralIntegrand[num,num2][canonicalLegs]/.{ab[q__]:>ab@@({q}/.Prepend[(relabelRules),shift[x_,y_]:>(shift[(x/.(relabelRules)),(y/.{ab[q1__]:>ab@@({q1}/.(relabelRules))})])])})]),(Block[{nums=({num,num2}),leftBox=Append[legList[[1;;3]],Join@@(legList[[4;;-1]])],rightBox=Join[{Prepend[Prepend[legList[[4]],legList[[3,-1]]],X2]},legList[[5;;6]],{Append[Append[legList[[7]],legList[[1,1]]],X1]}],cutProps,rtns,stdBoxes,merged,hexaCutPoint},stdBoxes={canonicalizeLegs@leftBox,canonicalizeLegs@rightBox};merged=(1/2mergePentaBox[chiralBox[nums[[1]]][stdBoxes[[1]]],(scalarTriangle[stdBoxes[[2]]])]/.mergerRule);hexaCutPoint=Total[(((hexaCutPointFix[merged][#]&/@((Join@@legList[[#]]&/@#&/@List[{{2},{3},{4},{5},{6},{7,1}},{{1,2},{3},{4},{5},{6},{7}},{{1},{2,3},{4},{5},{6},{7}},{{1},{2},{3,4},{5},{6},{7}}])))))];Set[chiralIntegrand[num,num2][legList],merged-hexaCutPoint]])]],Length[legList]==6,Block[{cutPts={shift[{legList[[1,1]],Join[legList[[5]],legList[[-1]]][[-1]]},(ab[legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[-2,1]],legList[[1,1]]]/ab[Join[legList[[5]],legList[[-1]]][[-1]],legList[[2,-1]],Join[legList[[3]],legList[[4]]][[1]],legList[[-2,1]]])],shift[{legList[[4,1]],Join[legList[[2]],legList[[3]]][[-1]]},(ab[legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]],legList[[4,1]]]/ab[Join[legList[[2]],legList[[3]]][[-1]],legList[[-2,-1]],Join[legList[[-1]],legList[[1]]][[1]],legList[[2,1]]])]}},cutPts={cutPts[[1]],cap[{Join[legList[[3]],legList[[4]]][[1]],legList[[2,-1]]},{legList[[1,-1]],legList[[2,1]],cutPts[[1]]}],cutPts[[2]],cap[{Join[legList[[-1]],legList[[1]]][[1]],legList[[-2,-1]]},{legList[[4,-1]],legList[[5,1]],cutPts[[2]]}]};Times[((ab@@cutPts)),Power[((cutPts[[1,2]]cutPts[[3,2]])ab[A,B,C,D](Times@@(Join@@({ab[A,B,##]&@@@#[[1;;3]],ab[C,D,##]&@@@#[[4;;-1]]}&@(RotateRight[{#1[[-1]],#2[[1]]}&@@@Partition[ReplacePart[legList,{3->Join[legList[[3]],legList[[4]],legList[[2]],legList[[3]]],6->Join[legList[[6]],legList[[1]],legList[[5]],legList[[6]]]}],2,1,1]]))))),-1]]],True,0];


(*   Local Integrand Representations *)
(*   ---   Amplitudes & Components   *)
localLoopIntegrand[n_,k_,ell_:2]/;(ell<=2):=Which[ell===0,{treeAmp[n,k]},ell===1,Block[{colouredBoxes=colouredOnShellGraphs[n,k,ell]},Join[DeleteCases[(Join@@Replace[colouredBoxes,box[x_,{y_,z_}]:>{boxes[1][x,y],boxes[2][x,z]},{1}]),boxes[num_][legs_,{}],{0,\[Infinity]}],If[n>4,Times[treeAmp[n,k],((scalarTriangle[{{#1},{#2},Mod[Range[n-2]+#3-1,n,1]}])&@@@Partition[Range[n],3,1,1])],{}]]],ell===2,(Block[{finitePart=colouredOnShellGraphs[n,k,ell],oneLoopFinite=Select[localLoopIntegrand[n,k,1],Count[#,treeAmp[__],{0,\[Infinity]}]==0&],oneLoopDivSquared},oneLoopDivSquared=treeAmp[n,k]doubleCompositeBox[{{#1},{#1+1},Range[#1+2,#2-1],{#2},Mod[{#2+1},n,1],Mod[Range[#2+2,#1+If[OrderedQ[{#2+1,#1}],0,n]-1],n,1]}]&@@@(Select[Subsets[Partition[Range[n],2,1,1],{2}],Length[DeleteDuplicates[Join@@#]]==4&][[All,All,1]]);Join[finitePart,((Join@@(oneLoopFinite/.{{boxes[num_][legs_,kList_]:>(Sequence@@(compositePentaBoxes[num][legs,#,kList]&/@(Join@@(Partition[#,2,1]&/@Select[legs,Length[#]>1&]))))},{boxes[num_][legs_,kList_]:>(Sequence@@(compositeDoubleBoxes[num][legs,#,kList]&/@(({#1[[-1]],#2[[1]]}&@@@Select[Partition[legs,4,1,1],Min[Length/@#[[3;;4]]]>1&]))))}}))),(oneLoopDivSquared)]]),True,{}];
superComponent[cmpt__][residue_]:=Block[{minorList=parseComponent[cmpt],ephN,result,resList},If[minorList===-1,0,If[Length[minorList[[1]]]===0,Total[residue],(resList=If[Head[residue[[1]]]===List,residue,{residue}];If[Not[Length[minorList[[1]]]==Length[resList[[1,2]]]],(Print["The R-charge of the requested component does not match that of the superfunction."];0),If[Not[Length[{cmpt}]==Length[resList[[1,2,1]]]],(Print["Component specification does not match the number of particles in the superfunction."];0),(ephN=Length[resList[[1,2,1]]];result=(#1*Times@@(Table[Det[#2[[All,j]]],{j,minorList}]))&@@@resList;If[Count[result,_Sqrt|Power[x_,1/2],{0,\[Infinity]}]==0||Not[NumericQ[Total[result]]],Total[result],Block[{ephOut=Total[N[result,600]],rOut,localFactors=evaluate[localPoles[ephN,2]]},rOut=Rationalize[ephOut*localFactors];If[IntegerQ[rOut]||And[Not[IntegerQ[localFactors]],Head[residue[[1]]]===List],rOut/localFactors,Total[result]]]])]])]]];parseComponent[x__]:=Block[{m,p,fp,fm},(If[Count[{x},m/2|p/2,\[Infinity]]>2,(Print[" Amplitudes involving more than one pair of fermions must be specified in more detail. Please specify the R-charges of each particle in question, referring to the manual if necessary."];-1),Block[{output,kCharge,gaugeList,signature,wList={x}/.{m/2->fm,p/2->fp,m->{1,2,3,4},p->{}}},If[Count[{x},m/2|p/2,\[Infinity]]>0,wList=(wList/.{(fm)->{1,2,3},(fp)->{4}});];If[Mod[Length[Cases[Flatten[wList],_Integer]],4]!=0,(Print["  Please recheck the R-charge assignments requested (they appear ill-formed)."];-1),(kCharge=Length[Cases[Flatten[wList],_Integer]]/4;If[(kCharge<0||kCharge>(Length[{x}]-4))&&Length[{x}]!=3,(Print["  The amplitude you requested vanishes because it is worse than MHV (or MHV-bar)."];-1),(gaugeList=Position[wList,#][[All,1]]&/@Range[4];If[Length[Intersection[Length/@gaugeList,Length/@gaugeList]]>1,(Print["  Please recheck the R-charge assignments requested (they appear ill-formed)."];-1),(signature=Signature[Flatten[Transpose[Position[Flatten[wList],#]&/@Range[4]]]];If[signature<=0,ReplacePart[gaugeList,{1->gaugeList[[1,Join[{2,1},Range[3,Length[gaugeList[[1]]]]]]]}],gaugeList])])])]]])];


If[Not[Quiet[NotebookDirectory[]]===$Failed],SetDirectory[NotebookDirectory[]]];
If[Head[Zs]===Symbol,referenceKinematics[10];];
End[];
EndPackage[]


referenceKinematics[8]


ephN=6;


(* ::Subsection:: *)
(*Sum for the MHV^3 term:*)


mhv3term[ephN_]:=Sum[1/3 mhvCubed[i1,i2,j1,j2,k1,k2,ephN],{i1,1,ephN},{i2,Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]},{j1,Take[#,Flatten[Position[#,i2]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]},{j2,Join[{j1},Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,i2]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]]},{k1,Take[#,Flatten[Position[#,j2]][[1]]-Length[#]]&@Join[{j1},Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,i2]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]]},{k2,Join[{k1},Take[#,Flatten[Position[#,k1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,j2]][[1]]-Length[#]]&@Join[{j1},Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,i2]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]]]}]


mhvCubed[i1_,i2_,j1_,j2_,k1_,k2_,ephN_]:=Which[
And[(i1!=i2),(j1!=j2),(k1!=k2)],boundaryTerm[i1,i2,j1,j2,k1,k2,ephN,1],
Or[And[(i1!=i2),(j1!=j2),(k1==k2)],And[(i1!=i2),(j1==j2),(k1!=k2)],And[(i1==i2),(j1!=j2),(k1!=k2)]],boundaryTerm[i1,i2,j1,j2,k1,k2,ephN,2],
(((i1!=i2)&&(j1==j2)&&(k1==k2))||((i1==i2)&&(j1!=j2)&&(k1==k2))||((i1==i2)&&(j1==j2)&&(k1!=k2))),boundaryTerm[i1,i2,j1,j2,k1,k2,ephN,3],
((i1==i2)&&(j1==j2)&&(k1==k2)),boundaryTerm[i1,i2,j1,j2,k1,k2,ephN,4]
];


boundaryTerm[i1_,i2_,j1_,j2_,k1_,k2_,ephN_,case_]:=Which[
case==1,num1[i1,i2,j1,j2,k1,k2,ephN]/den1[i1,i2,j1,j2,k1,k2,ephN],
case==2,Which[i1==i2,num2[i1,j1,j2,k1,k2,ephN]/den2[i1,j1,j2,k1,k2,ephN],j1==j2,num3[i1,i2,j1,k1,k2,ephN]/den3[i1,i2,j1,k1,k2,ephN],k1==k2,num4[i1,i2,j1,j2,k1,ephN]]/den4[i1,i2,j1,j2,k1,ephN],
case==3,Which[((i1==i2)&&(j1==j2)),num5[i1,j1,k1,k2,ephN]/den5[i1,j1,k1,k2,ephN],(i1==i2)&&(k1==k2),num6[i1,j1,j2,k1,ephN]/den6[i1,j1,j2,k1,ephN],(k1==k2)&&(j1==j2),num7[i1,i2,j1,k1,ephN]/den7[i1,i2,j1,k1,ephN]],
case==4,num8[i1,j1,k1,ephN]/den8[i1,j1,k1,ephN]
]


num1[i1_,i2_,j1_,j2_,k1_,k2_,ephN_]:=(ab[A,B,cap[{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]},{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]}]]ab[C,D,cap[{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]},{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]}]]ab[F,G,cap[{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]},{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]}]])ab[i2,j1,cap[{j2,k1,cap[{k2,i1,A},{G,F}]},{D,C}],B]-ab[i2,j1,cap[{j2,k1,cap[{k2,i1,B},{G,F}]},{D,C}],A];
num2[i1_,j1_,j2_,k1_,k2_,ephN_]:=(ab[C,D,cap[{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]},{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]}]]ab[F,G,cap[{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]},{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]}]])ab[i1,j1,cap[{j2,k1,cap[{k2,i1,Mod[i1-1,ephN,1]},{G,F}]},{D,C}],Mod[i1+1,ephN,1]]-ab[i1,j1,cap[{j2,k1,cap[{k2,i1,Mod[i1+1,ephN,1]},{G,F}]},{D,C}],Mod[i1-1,ephN,1]];
num3[i1_,i2_,j1_,k1_,k2_,ephN_]:=(ab[A,B,cap[{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]},{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]}]]ab[F,G,cap[{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]},{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]}]])ab[i2,j1,cap[{j1,k1,cap[{k2,i1,A},{G,F}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],B]-ab[i2,j1,cap[{j1,k1,cap[{k2,i1,B},{G,F}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],A];
num4[i1_,i2_,j1_,j2_,k1_,ephN_]:=(ab[A,B,cap[{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]},{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]}]]ab[C,D,cap[{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]},{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]}]])ab[i2,j1,cap[{j2,k1,cap[{k1,i1,A},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{D,C}],B]-ab[i2,j1,cap[{j2,k1,cap[{k1,i1,B},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{D,C}],A];
num5[i1_,j1_,k1_,k2_,ephN_]:=(ab[F,G,cap[{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]},{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]}]])ab[i1,j1,cap[{j1,k1,cap[{k2,i1,Mod[i1-1,ephN,1]},{G,F}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],Mod[i1+1,ephN,1]]-ab[i1,j1,cap[{j1,k1,cap[{k2,i1,Mod[i1+1,ephN,1]},{G,F}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],Mod[i1-1,ephN,1]];
num6[i1_,j1_,j2_,k1_,ephN_]:=(ab[C,D,cap[{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]},{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]}]])ab[i1,j1,cap[{j2,k1,cap[{k1,i1,Mod[i1-1,ephN,1]},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{D,C}],Mod[i1+1,ephN,1]]-ab[i1,j1,cap[{j2,k1,cap[{k1,i1,Mod[i1+1,ephN,1]},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{D,C}],Mod[i1-1,ephN,1]];
num7[i1_,i2_,j1_,k1_,ephN_]:=(ab[A,B,cap[{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]},{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]}]])ab[i2,j1,cap[{j1,k1,cap[{k1,i1,A},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],B]-ab[i2,j1,cap[{j1,k1,cap[{k1,i1,B},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],A];
num8[i1_,j1_,k1_,ephN_]:=ab[i1,j1,cap[{j1,k1,cap[{k1,i1,Mod[i1-1,ephN,1]},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],Mod[i1+1,ephN,1]]-ab[i1,j1,cap[{j1,k1,cap[{k1,i1,Mod[i1+1,ephN,1]},{Mod[k1+1,ephN,1],Mod[k1-1,ephN,1]}]},{Mod[j1+1,ephN,1],Mod[j1-1,ephN,1]}],Mod[i1-1,ephN,1]];
den1[i1_,i2_,j1_,j2_,k1_,k2_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[A,B,Mod[i2-1,ephN,1],i2]ab[A,B,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[C,D,Mod[j2-1,ephN,1],j2]ab[C,D,j2,Mod[j2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den2[i1_,j1_,j2_,k1_,k2_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[C,D,Mod[j2-1,ephN,1],j2]ab[C,D,j2,Mod[j2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den3[i1_,i2_,j1_,k1_,k2_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[A,B,Mod[i2-1,ephN,1],i2]ab[A,B,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den4[i1_,i2_,j1_,j2_,k1_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[A,B,Mod[i2-1,ephN,1],i2]ab[A,B,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[C,D,Mod[j2-1,ephN,1],i2]ab[C,D,j2,Mod[j2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den5[i1_,j1_,k1_,k2_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den6[i1_,j1_,j2_,k1_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[C,D,Mod[j2-1,ephN,1],j2]ab[C,D,j2,Mod[j2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den7[i1_,i2_,j1_,k1_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[A,B,Mod[i2-1,ephN,1],i2]ab[A,B,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];
den8[i1_,j1_,k1_,ephN_]:=ab[A,B,Mod[i1-1,ephN,1],i1]ab[A,B,i1,Mod[i1+1,ephN,1]]ab[C,D,Mod[j1-1,ephN,1],j1]ab[C,D,j1,Mod[j1+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]ab[A,B,C,D]ab[A,B,F,G]ab[C,D,F,G];


(* ::Subsection:: *)
(*Sum for the MHV^2 x NMHV term:*)


mhv2nmhvterm[ephN_]:=Sum[1/2 mhvSqNMHV[i1,j1,k1,k2,j2,i2,ephN],{i1,1,ephN},{j1,Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]},{k1,Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]},{k2,Take[#,Flatten[Position[#,k1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]},{j2,Join[{k2},Take[#,Flatten[Position[#,k2]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,k1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]]},{i2,Take[#,Flatten[Position[#,j2]][[1]]-Length[#]]&@Join[{k2},Take[#,Flatten[Position[#,k2]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,k1]][[1]]-Length[#]]&@Take[#,Flatten[Position[#,j1]][[1]]-Length[#]]&@Join[{i1},RotateLeft[Complement[Range[ephN],{i1}],i1-1]]]}]


numNMHV[i1_,j1_,k1_,k2_,j2_,i2_,ephN_,case_]:=Which[case==1,ab[F,G,cap[{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]},{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]}]]ab[C,D,cap[{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]},{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]}]]ab[k2,i2,j1,Mod[j1+1,ephN,1]]ab[A,B,cap[{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]},{i1,k1,k2}]],case==2,ab[F,G,cap[{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]},{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]}]]ab[C,D,cap[{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]},{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]}]]ab[A,B,cap[{i2,i1,k2},{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]}]]ab[Mod[k2+1,ephN,1],j1,k1,k2],case==3,ab[F,G,cap[{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]},{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]}]]ab[C,D,cap[{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]},{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]}]]ab[k2,i2,i1,Mod[i1+1,ephN,1]]ab[Mod[k1+1,ephN,1],i1,k1,k2],case==4,ab[F,G,cap[{Mod[k2-1,ephN,1],k2,Mod[k2+1,ephN,1]},{Mod[k1-1,ephN,1],k1,Mod[k1+1,ephN,1]}]]ab[C,D,cap[{Mod[i2-1,ephN,1],i2,Mod[i2+1,ephN,1]},{Mod[i1-1,ephN,1],i1,Mod[i1+1,ephN,1]}]]ab[A,B,cap[{i2,i1,j2},{Mod[j1-1,ephN,1],j1,Mod[j1+1,ephN,1]}]]ab[A,B,cap[{Mod[j2-1,ephN,1],j2,Mod[j2+1,ephN,1]},{j1,k1,k2}]]];
denNMHV[i1_,j1_,k1_,k2_,j2_,i2_,ephN_,case_]:=Which[case==1,(ab[A,B,j2,Mod[j2+1,ephN,1]]ab[A,B,Mod[j2-1,ephN,1],j2]ab[A,B,j1,Mod[j1+1,ephN,1]])ab[A,B,C,D]ab[A,B,F,G]ab[C,D,Mod[i2-1,ephN,1],i2]ab[C,D,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[i1-1,ephN,1],i1]ab[C,D,i1,Mod[i1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]],case==2,(ab[A,B,j2,Mod[j2+1,ephN,1]]ab[A,B,Mod[j1-1,ephN,1],j1]ab[A,B,j1,Mod[j1+1,ephN,1]])ab[A,B,C,D]ab[A,B,F,G]ab[C,D,Mod[i2-1,ephN,1],i2]ab[C,D,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[i1-1,ephN,1],i1]ab[C,D,i1,Mod[i1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]],case==3,(ab[A,B,j2,Mod[j2+1,ephN,1]]ab[A,B,j1,Mod[j1+1,ephN,1]])ab[A,B,C,D]ab[A,B,F,G]ab[C,D,Mod[i2-1,ephN,1],i2]ab[C,D,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[i1-1,ephN,1],i1]ab[C,D,i1,Mod[i1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]],case==4,(ab[A,B,j2,Mod[j2+1,ephN,1]]ab[A,B,Mod[j2-1,ephN,1],j2]ab[A,B,Mod[j1-1,ephN,1],j1]ab[A,B,j1,Mod[j1+1,ephN,1]])ab[A,B,C,D]ab[A,B,F,G]ab[C,D,Mod[i2-1,ephN,1],i2]ab[C,D,i2,Mod[i2+1,ephN,1]]ab[C,D,Mod[i1-1,ephN,1],i1]ab[C,D,i1,Mod[i1+1,ephN,1]]ab[F,G,Mod[k2-1,ephN,1],k2]ab[F,G,k2,Mod[k2+1,ephN,1]]ab[F,G,Mod[k1-1,ephN,1],k1]ab[F,G,k1,Mod[k1+1,ephN,1]]];
mhvSqNMHV[i1_,j1_,k1_,k2_,j2_,i2_,ephN_]:=Which[And[i1==j1,k2!=j2],numNMHV[i1,j1,k1,k2,j2,i2,ephN,1]/denNMHV[i1,j1,k1,k2,j2,i2,ephN,1],And[i1!=j1,k2==j2],numNMHV[i1,j1,k1,k2,j2,i2,ephN,2]/denNMHV[i1,j1,k1,k2,j2,i2,ephN,2],And[i1==j1,k2==j2],numNMHV[i1,j1,k1,k2,j2,i2,ephN,3]/denNMHV[i1,j1,k1,k2,j2,i2,ephN,3],True,numNMHV[i1,j1,k1,k2,j2,i2,ephN,4]/denNMHV[i1,j1,k1,k2,j2,i2,ephN,4]];


List@@mhv2nmhvterm[6];
Length[%](*not symmetrized, so every term is different? i may be wrong on this*)


List@@mhv3term[6];
(Length[%]/3!)(*symmetrized, so divide by 1/3! perms*)


Flatten[Position[Length/@Denominator/@(3List@@mhv3term[9]),15]]
3List@@mhv3term[9][[%]];
Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]]



(* ::Subsection:: *)
(*Calculating all residues(sequentially):*)


residue[x_,{y_,z_}]:=Block[{first=TimeConstrained[Quiet[Residue[x,{y,z}]],1,"?"]},If[Head[first]===Residue||first==="?",Block[{second,series=Quiet[PowerExpand[Quiet[Factor[Quiet[Normal[Series[x,{y,z,1}]]]]]]]},second=TimeConstrained[Residue[series,{y,z}],1,"?"];If[Head[second]===Residue||second==="?",0,second]],first]];

nextCuts[polePlace_,jac_]:=Block[{jacDen=Together[jac],nextCuts,nextPoles,nextJac},If[Length[Variables[jacDen]]==0,{{polePlace,jac}},(nextCuts=TimeConstrained[Select[Solve[jacDen==0],Length[#]==1&],2,{}];nextPoles=Sort[Join[Quiet@Simplify[Quiet[(polePlace/.#)]],#]]&/@nextCuts;nextJac=If[#===0,0,1/#]&/@(residue[1/jac,{#[[1,1]],#[[1,2]]}]&/@nextCuts);Select[Transpose[{nextPoles,nextJac}],Count[#,ComplexInfinity|Indeterminate,{0,\[Infinity]}]==0&])]];
allResidues[{poleList_,jacList_}]:=Block[{full=FixedPoint[(Join@@(nextCuts@@@#))&,Transpose[{poleList,jacList}]],dist},dist=Flatten[Position[full[[All,1]],#][[1]]&/@DeleteDuplicates[full[[All,1]]]];full[[dist]]];

maxCuts[props_]:=Block[{nProps,nCuts,nJacs},nProps=Block[{Zs=varZs},evaluate[props]];nCuts=Factor[Select[Solve[nProps==0],Length[#]==Length[props]&]];nJacs=Factor[Det[D[nProps,{#[[All,1]]}]/.#]]&/@nCuts;allResidues[{nCuts,nJacs}]];
capRulesCD={ab[C,D,cap[y_,z_,q___],w___]:>If[Length[Join[y,z]]==5,(ab[C,D,#1,w]&)/@y . Apply[ab,RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]],{1}],Total[Apply[ab[C,D,#1,#2,w] ab@@Prepend[z,#3]&,Partition[y,3,1,1],{1}]]],ab[x___,y_,z___,y_,w___]->0};
capRulesAB={ab[A,B,cap[y_,z_,q___],w___]:>If[Length[Join[y,z]]==5,(ab[A,B,#1,w]&)/@y . Apply[ab,RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]],{1}],Total[Apply[ab[A,B,#1,#2,w] ab@@Prepend[z,#3]&,Partition[y,3,1,1],{1}]]],ab[x___,y_,z___,y_,w___]->0};
capRulesFG={ab[F,G,cap[y_,z_,q___],w___]:>If[Length[Join[y,z]]==5,(ab[F,G,#1,w]&)/@y . Apply[ab,RotateLeft[Partition[Join[y,z],4,1,1]][[1;;Length[y]]],{1}],Total[Apply[ab[F,G,#1,#2,w] ab@@Prepend[z,#3]&,Partition[y,3,1,1],{1}]]],ab[x___,y_,z___,y_,w___]->0};


allResidues[{poleList_,jacList_}]:=Block[{full=FixedPoint[(Join@@(nextCuts@@@#))&,Transpose[{poleList,jacList}]],dist},
dist=Flatten[Position[full[[All,1]],#][[1]]&/@DeleteDuplicates[full[[All,1]]]];
full[[dist]]];
nextCuts[polePlace_,jac_]:=Block[{jacDen=Together[jac],nextCuts,nextPoles,nextJac},
If[Length[Variables[jacDen]]==0,{{polePlace,jac}},(nextCuts=TimeConstrained[Select[Solve[jacDen==0],Length[#]==1&],2,{}];
nextPoles=Sort[Join[Quiet@Simplify[Quiet[(polePlace/.#)]],#]]&/@nextCuts;
nextJac=If[#===0,0,1/#]&/@(residue[1/jac,{#[[1,1]],#[[1,2]]}]&/@nextCuts);
Select[Transpose[{nextPoles,nextJac}],Count[#,ComplexInfinity|Indeterminate,{0,\[Infinity]}]==0&])]];


residue[2/((x+1)^(1/2) (x-1)),{x,-1}]
residue[2/((x+1)^(1/2) (x-1)),{x,1}]


(* ::Subsection:: *)
(*8-pt 3-loop leading singularities check:*)


(* ::Subsubsection::Closed:: *)
(*mhv2nmhvterm doublePentaHex (14 props(exhaustive)):*)


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[1]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);


cutData=(maxCuts/@goodPropList);


Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[2]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);


Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[3]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[4]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[5]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[6]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[7]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


ephN=8;
referenceKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};
pentHexPentsPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),14]];
doublePentHexes=(2List@@mhv2nmhvterm[8])[[pentHexPentsPos]];
testInt=doublePentHexes[[8]];
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


2(List@@mhv2nmhvterm[8])//Length


(* ::Subsubsection::Closed:: *)
(*mhv2nmhvterm hexaPentaBox / triplePenta degeneration(13 props(exhaustive(only non-unit))):*)


hexaPentaBoxPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),13]];
hexaPentaBoxes=(2List@@mhv2nmhvterm[8])[[hexaPentaBoxPos]];
ephN=8;
randomPositiveKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};


testInt=hexaPentaBoxes[[15]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[19]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[20]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[22]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[29]]//.capRulesCD//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[40]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


Length[hexaPentaBoxes]


testInt=hexaPentaBoxes[[57]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[72]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[76]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[77]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[81]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[82]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[103]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[105]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[106]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[107]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[110]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[113]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[130]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[135]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[144]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[153]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[155]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


testInt=hexaPentaBoxes[[157]]//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


Length/@Denominator/@(2List@@mhv2nmhvterm[8])


(* ::Subsubsection:: *)
(*mhv2nmhvterm hexadoubleBox / doublePentaBox(12 props(exhaustive(only non-unit))):*)


doublePentaBoxPos=Flatten[Position[Length/@Denominator/@(2List@@mhv2nmhvterm[8]),12]];
doublePentaBoxes=(2List@@mhv2nmhvterm[8])[[doublePentaBoxPos]];
ephN=8;
randomPositiveKinematics[ephN]
varZs=Join[Zs[[1;;-7]],{{1,\[Alpha][1],0,\[Alpha][2]},{0,\[Alpha][3],1,\[Alpha][4]},{1,\[Beta][1],0,\[Beta][2]},{0,\[Beta][3],1,\[Beta][4]},{1,\[Gamma][1],0,\[Gamma][2]},{0,\[Gamma][3],1,\[Gamma][4]}}];
nice/@{Zs,varZs};


nonUnitListPos=nonUnitList;
nonUnitListPos


testInt=doublePentaBoxes[[338]]//.capRulesCD//.capRulesFG//Simplify;
testInt//nice
propList=Subsets[List@@Denominator[testInt],{12}];
goodCutsPos=Complement[Range[Length[#]],Flatten[Position[#,{}]]]&@(maxCuts/@propList);
goodPropList=propList[[goodCutsPos]];
goodProps=(Times@@goodPropList[[#]]&/@Range[Length[goodPropList]]);
cutData=(maxCuts/@goodPropList);
Block[{Zs=varZs},(evaluate[testInt*goodProps[[#]]]/.(cutData)[[All,1,1]][[#]])/(cutData)[[All,1,2]][[#]]&/@Range[Length[goodProps]]]
Total[%]


nonUnitList
